

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Driving a Financial Valuation from a Design Scenario &#8212; Rangekeeper</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'drive_model_from_design_scenario';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Loading a Design Scenario" href="load_design_scenario.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
    
    
      
    
    
    <img src="_static/rangekeeper.jpg" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="_static/rangekeeper.jpg" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Rangekeeper
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Real Estate Flexibility and Valuation under Uncertainty</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="basic_dcf.html">A Basic Discounted Cash Flow Valuation</a></li>
<li class="toctree-l1"><a class="reference internal" href="deterministic_scenarios.html">Deterministic Scenario Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_dynamics.html">Real Estate Pricing Factor Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="flexibility_intro.html">Introduction to Modeling Flexibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="flexibility_under_uncertainty.html">Flexibility under Uncertainty</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Using Rangekeeper in Examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="load_design_scenario.html">Loading a Design Scenario</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Driving a Financial Valuation from a Design Scenario</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/daniel-fink/rangekeeper/blob/main/walkthrough/drive_model_from_design_scenario.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/daniel-fink/rangekeeper" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/daniel-fink/rangekeeper/issues/new?title=Issue%20on%20page%20%2Fdrive_model_from_design_scenario.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/drive_model_from_design_scenario.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Driving a Financial Valuation from a Design Scenario</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-design-scenario">Load the Design Scenario</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-model-graph">Inspect the Model Graph</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assigning-and-aggregating-flows-per-entity">Assigning and Aggregating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revenue-producing-entities">Revenue-producing Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-aggregation">Simple Aggregation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-a-financial-calculation">Aggregating a (Financial) Calculation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#streams-of-revenue-flows-per-entity"><code class="docutils literal notranslate"><span class="pre">Stream</span></code>s of Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-by-parent-container">Aggregating by Parent Container</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-generating-entities">Cost-generating Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-and-capital-expenses-of-building-utilities-systems">Operational and Capital Expenses of Building Utilities &amp; Systems</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-flows-per-entity">Cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="driving-a-financial-valuation-from-a-design-scenario">
<h1>Driving a Financial Valuation from a Design Scenario<a class="headerlink" href="#driving-a-financial-valuation-from-a-design-scenario" title="Permalink to this heading">#</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The following is a work in progress. More content will be added as produced.</p>
</div>
<p>As seen in
<a class="reference internal" href="load_design_scenario.html"><span class="doc std std-doc">Loading a Design Scenario</span></a>,
a design scenario’s object model (a
<a class="reference external" href="https://en.wikipedia.org/wiki/Knowledge_graph">knowledge graph</a> including all
its spatial and semantic relationships) can be loaded via Speckle from any of
Speckle’s supported <a class="reference external" href="https://speckle.guide/user/connectors.html">connectors</a>, so
long as those objects (<code class="docutils literal notranslate"><span class="pre">Entity</span></code>s and <code class="docutils literal notranslate"><span class="pre">Relationship</span></code>s) have been assigned.</p>
<p>In this notebook, we will demonstrate how to use the object model (graph) to
drive a financial valuation of the design scenario. This is done by calculating
cash flows per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>, and then using the <code class="docutils literal notranslate"><span class="pre">Relationship</span></code>s to aggregate those
<code class="docutils literal notranslate"><span class="pre">Flow</span></code>s into appropriate <code class="docutils literal notranslate"><span class="pre">Stream</span></code>s.</p>
<section id="load-the-design-scenario">
<h2>Load the Design Scenario<a class="headerlink" href="#load-the-design-scenario" title="Permalink to this heading">#</a></h2>
<p>We will use the same design scenario as in the previous notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">IFrame</span>
<span class="kn">import</span> <span class="nn">plotly.subplots</span>
<span class="kn">import</span> <span class="nn">plotly.offline</span> <span class="k">as</span> <span class="nn">py</span>

<span class="kn">import</span> <span class="nn">rangekeeper</span> <span class="k">as</span> <span class="nn">rk</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">speckle</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Speckle</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;speckle.xyz&quot;</span><span class="p">,</span>
    <span class="n">token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SPECKLE_TOKEN&#39;</span><span class="p">))</span>
<span class="n">stream_id</span> <span class="o">=</span> <span class="s2">&quot;f5e306e3fa&quot;</span>
<span class="n">commit_id</span> <span class="o">=</span> <span class="n">speckle</span><span class="o">.</span><span class="n">get_latest_commit_id</span><span class="p">(</span><span class="n">stream_id</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="s2">&quot;https://speckle.xyz/embed?stream=</span><span class="si">{0}</span><span class="s2">&amp;commit=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> SpeckleClient( server: https://speckle.xyz, authenticated: True )
</pre></div>
</div>
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="https://speckle.xyz/embed?stream=f5e306e3fa&commit=ad17a888c3"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<section id="inspect-the-model-graph">
<h3>Inspect the Model Graph<a class="headerlink" href="#inspect-the-model-graph" title="Permalink to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">speckle</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">stream_id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Speckle</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;@scenario&#39;</span><span class="p">])</span>
<span class="n">scenario</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Speckle</span><span class="o">.</span><span class="n">to_rk</span><span class="p">(</span>
    <span class="n">bases</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;design_scenario&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;scenario&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: Duplicate Entity 29b746f5-42fe-4321-9a4a-8c65c9f0410c [utilities] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
Warning: Duplicate Entity 29b746f5-42fe-4321-9a4a-8c65c9f0410c [utilities] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
Warning: Duplicate Entity 29b746f5-42fe-4321-9a4a-8c65c9f0410c [utilities] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
Warning: Duplicate Entity d188b4bb-27a3-4f63-9469-e9705c60a7a5 [plinthparking] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;assets/design_scenario&#39;</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;./design_scenario.html&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>assets/design_scenario.html
</pre></div>
</div>
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="./design_scenario.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
</section>
<section id="assigning-and-aggregating-flows-per-entity">
<h2>Assigning and Aggregating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code><a class="headerlink" href="#assigning-and-aggregating-flows-per-entity" title="Permalink to this heading">#</a></h2>
<p>Now we can organise the two main categories of cash flows (costs and revenues)
according to the <code class="docutils literal notranslate"><span class="pre">Relationship</span></code> types in the design scenario.</p>
<p>In this example, revenue-based cash flows are generated by <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have a
measureable floor area – in this case, anything that has a ‘gfa’ property.</p>
<p>We can query the graph to find them:</p>
<section id="revenue-producing-entities">
<h3>Revenue-producing Entities<a class="headerlink" href="#revenue-producing-entities" title="Permalink to this heading">#</a></h3>
<p>Revenue-producing <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s will be aggregated by their spatial containment. So
we can first slice our graph to a tree of nodes that have “contains”
relationships:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_containment</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">filter_by_type</span><span class="p">(</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spatial_containment&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note: we anticipate that the spatial decomposition is completely hierarchical
(i.e., no spaces overlap, which means no spaces have multiple parents). We can
check this by testing whether the containment graph is a “tree” (or
“arborescence”: see <a class="reference external" href="https://networkx.org/documentation/stable/reference/algorithms/tree.html#tree">NetworkX Tree</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nx</span><span class="o">.</span><span class="n">is_arborescence</span><span class="p">(</span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the spatial containment graph</span>
<span class="n">spatial_containment</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;assets/spatial_containment&#39;</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;./spatial_containment.html&quot;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>assets/spatial_containment.html
</pre></div>
</div>
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="./spatial_containment.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<section id="simple-aggregation">
<h4>Simple Aggregation<a class="headerlink" href="#simple-aggregation" title="Permalink to this heading">#</a></h4>
<p>Now that we have verified this, we can continue with a simple aggregation. We
wish to aggregate up through our hierarchy all <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have a Gross Floor
Area (‘gfa’) property. <em>Rangekeeper</em> provides defaults for the <code class="docutils literal notranslate"><span class="pre">Entity.aggregate()</span></code>
method for this, whereby a named property of any <code class="docutils literal notranslate"><span class="pre">Entity</span></code> is summed (numerical
addition) into its parent <code class="docutils literal notranslate"><span class="pre">Entity</span></code> against a specified label:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scenario</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;gfa&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can tabulate this by converting the graph to a pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. Note that
the graph nodes (as witnessed in the DataFrame’s index and ‘parent’ column)
are GUID strings. Each of these have corresponding <code class="docutils literal notranslate"><span class="pre">Entity</span></code> objects, organised
via NetworkX’s Node Attributes. See <a class="reference external" href="https://networkx.org/documentation/stable/tutorial.html#what-to-use-as-nodes-and-edges">NetworkX Tutorial</a></p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">to_DataFrame</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;gfa&#39;</span><span class="p">,</span> <span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;ffl&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">]]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>type</th>
      <th>gfa</th>
      <th>subtotal_gfa</th>
      <th>parent</th>
      <th>use</th>
      <th>ffl</th>
      <th>number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>a39ac4c3-094b-4d92-b71d-46c5a857f407</th>
      <td>development</td>
      <td>development</td>
      <td>NaN</td>
      <td>45816.419959</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>981c0743-6a4c-4abd-8a97-2c937e48b897</th>
      <td>buildingB</td>
      <td>building</td>
      <td>NaN</td>
      <td>13436.884829</td>
      <td>a39ac4c3-094b-4d92-b71d-46c5a857f407</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>e3149444-dfbc-41d0-9eb1-f08785a62da1</th>
      <td>plinth</td>
      <td>building</td>
      <td>NaN</td>
      <td>12773.744211</td>
      <td>a39ac4c3-094b-4d92-b71d-46c5a857f407</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</th>
      <td>buildingA</td>
      <td>building</td>
      <td>NaN</td>
      <td>19605.790919</td>
      <td>a39ac4c3-094b-4d92-b71d-46c5a857f407</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>29b746f5-42fe-4321-9a4a-8c65c9f0410c</th>
      <td>utilities</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>a39ac4c3-094b-4d92-b71d-46c5a857f407</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3fc29315-81e7-45a9-8241-62938e904d73</th>
      <td>buildingBresidential</td>
      <td>space</td>
      <td>NaN</td>
      <td>11442.736624</td>
      <td>981c0743-6a4c-4abd-8a97-2c937e48b897</td>
      <td>residential</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>f508623d-1d81-4082-85ee-5b1e32c7bb10</th>
      <td>buildingBparking</td>
      <td>space</td>
      <td>NaN</td>
      <td>1178.164752</td>
      <td>981c0743-6a4c-4abd-8a97-2c937e48b897</td>
      <td>parking</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6ac8ab6d-a730-44b8-97aa-a5db09b7fbd0</th>
      <td>buildingBretail</td>
      <td>space</td>
      <td>NaN</td>
      <td>815.983454</td>
      <td>981c0743-6a4c-4abd-8a97-2c937e48b897</td>
      <td>retail</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>71fd4551-8e65-4e7a-8e2a-9d18e69146b0</th>
      <td>buildingBcores</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>981c0743-6a4c-4abd-8a97-2c937e48b897</td>
      <td>cores</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>c11f68da-0544-487b-9cb9-8a3a3a98a9b8</th>
      <td>buildingBresidentialFloor0</td>
      <td>floor</td>
      <td>765.941631</td>
      <td>765.941631</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>cfc3edf5-1e7d-4499-b25f-ee86ed013516</th>
      <td>buildingBresidentialFloor1</td>
      <td>floor</td>
      <td>2361.056035</td>
      <td>2361.056035</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>5.3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>3e158dd9-aa5d-47bb-bc13-4b3e6d328fe1</th>
      <td>buildingBresidentialFloor2</td>
      <td>floor</td>
      <td>2361.056035</td>
      <td>2361.056035</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>8.4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>b8609a1e-b9f8-44a0-ab98-468ff247d753</th>
      <td>buildingBresidentialFloor3</td>
      <td>floor</td>
      <td>2015.956035</td>
      <td>2015.956035</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>11.5</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>f68d2f9b-13c5-42e2-9bca-1826f7eff481</th>
      <td>buildingBresidentialFloor4</td>
      <td>floor</td>
      <td>2015.956035</td>
      <td>2015.956035</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>14.6</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>ec086fbc-7b21-4958-b456-9bce6a883c98</th>
      <td>buildingBresidentialFloor5</td>
      <td>floor</td>
      <td>875.014900</td>
      <td>875.014900</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>17.7</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>9ecaf92a-a90e-4572-a426-3ed392e0c28a</th>
      <td>buildingBresidentialFloor6</td>
      <td>floor</td>
      <td>875.014900</td>
      <td>875.014900</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>20.8</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>9a884f88-0627-4eb7-b1ec-80ea39b0a25b</th>
      <td>buildingBresidentialFloor0</td>
      <td>floor</td>
      <td>172.741054</td>
      <td>172.741054</td>
      <td>3fc29315-81e7-45a9-8241-62938e904d73</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>d7dd5233-b1c3-451f-ae90-5a80fed205bd</th>
      <td>buildingBparkingFloor0</td>
      <td>floor</td>
      <td>1178.164752</td>
      <td>1178.164752</td>
      <td>f508623d-1d81-4082-85ee-5b1e32c7bb10</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4acebff3-f17b-44fb-ba29-6bc02053b329</th>
      <td>buildingBretailFloor0</td>
      <td>floor</td>
      <td>815.983454</td>
      <td>815.983454</td>
      <td>6ac8ab6d-a730-44b8-97aa-a5db09b7fbd0</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>d188b4bb-27a3-4f63-9469-e9705c60a7a5</th>
      <td>plinthparking</td>
      <td>space</td>
      <td>NaN</td>
      <td>12773.744211</td>
      <td>e3149444-dfbc-41d0-9eb1-f08785a62da1</td>
      <td>parking</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>8d9f92cf-5613-4de4-b99b-7681aa76b4cd</th>
      <td>plinthplant</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>e3149444-dfbc-41d0-9eb1-f08785a62da1</td>
      <td>plant</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>cf287254-7d66-4a4b-8a56-f247f51b41db</th>
      <td>plinthparkingFloor-2</td>
      <td>floor</td>
      <td>6386.872106</td>
      <td>6386.872106</td>
      <td>d188b4bb-27a3-4f63-9469-e9705c60a7a5</td>
      <td>NaN</td>
      <td>-5.9</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>926a3e9d-0601-4f96-bd71-317d928194f2</th>
      <td>plinthparkingFloor-1</td>
      <td>floor</td>
      <td>6386.872106</td>
      <td>6386.872106</td>
      <td>d188b4bb-27a3-4f63-9469-e9705c60a7a5</td>
      <td>NaN</td>
      <td>-2.8</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>987c5866-03b0-4948-962e-4870684f481b</th>
      <td>buildingAparking</td>
      <td>space</td>
      <td>NaN</td>
      <td>960.262087</td>
      <td>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</td>
      <td>parking</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7dc6bf46-805f-4990-bcd2-d0fe1de4dd47</th>
      <td>buildingAretail</td>
      <td>space</td>
      <td>NaN</td>
      <td>534.530238</td>
      <td>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</td>
      <td>retail</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>549a988b-c3bc-42d4-a6a3-a8dc694fa770</th>
      <td>buildingAresidential</td>
      <td>space</td>
      <td>NaN</td>
      <td>2296.143091</td>
      <td>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</td>
      <td>residential</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3cf2bf71-61fa-4a61-b163-6265c299376d</th>
      <td>buildingAretail</td>
      <td>space</td>
      <td>NaN</td>
      <td>1123.715326</td>
      <td>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</td>
      <td>retail</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>bfc1c272-665f-432d-a7b3-a4c955556e7f</th>
      <td>buildingAoffice</td>
      <td>space</td>
      <td>NaN</td>
      <td>14691.140177</td>
      <td>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</td>
      <td>office</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>55963d84-702d-423d-be05-c8bb6e88f517</th>
      <td>buildingAcores</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>529ce7bc-addf-4bad-8ec5-cbecbd73d4f1</td>
      <td>cores</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>01282060-ad91-44be-b0d3-ff43e340e8bd</th>
      <td>buildingAparkingFloor0</td>
      <td>floor</td>
      <td>960.262087</td>
      <td>960.262087</td>
      <td>987c5866-03b0-4948-962e-4870684f481b</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>f9e9ae1c-00f3-4966-9682-281ef2a86899</th>
      <td>buildingAretailFloor0</td>
      <td>floor</td>
      <td>534.530238</td>
      <td>534.530238</td>
      <td>7dc6bf46-805f-4990-bcd2-d0fe1de4dd47</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>e7b3aec0-5003-448b-a0e3-4c2dbb605f85</th>
      <td>buildingAresidentialFloor0</td>
      <td>floor</td>
      <td>57.900000</td>
      <td>57.900000</td>
      <td>549a988b-c3bc-42d4-a6a3-a8dc694fa770</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>9c13f0be-9991-4d9f-b41b-a0e962bdeb89</th>
      <td>buildingAresidentialFloor0</td>
      <td>floor</td>
      <td>43.800000</td>
      <td>43.800000</td>
      <td>549a988b-c3bc-42d4-a6a3-a8dc694fa770</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>e88ff464-a453-45bb-93d8-5f983d417912</th>
      <td>buildingAresidentialFloor1</td>
      <td>floor</td>
      <td>731.481030</td>
      <td>731.481030</td>
      <td>549a988b-c3bc-42d4-a6a3-a8dc694fa770</td>
      <td>NaN</td>
      <td>5.3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>8ce80d06-69f6-404a-b0fd-a728eb0dfed6</th>
      <td>buildingAresidentialFloor2</td>
      <td>floor</td>
      <td>731.481030</td>
      <td>731.481030</td>
      <td>549a988b-c3bc-42d4-a6a3-a8dc694fa770</td>
      <td>NaN</td>
      <td>8.4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>bb0a0d86-31c1-4780-b81f-8d0e5a5d83be</th>
      <td>buildingAresidentialFloor3</td>
      <td>floor</td>
      <td>731.481030</td>
      <td>731.481030</td>
      <td>549a988b-c3bc-42d4-a6a3-a8dc694fa770</td>
      <td>NaN</td>
      <td>11.5</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>32080c6a-1f31-446f-a3d9-59759ac00ff4</th>
      <td>buildingAretailFloor0</td>
      <td>floor</td>
      <td>1123.715326</td>
      <td>1123.715326</td>
      <td>3cf2bf71-61fa-4a61-b163-6265c299376d</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>a1fc1a28-1133-47f2-a8d9-58da817946c2</th>
      <td>buildingAofficeFloor1</td>
      <td>floor</td>
      <td>1650.842103</td>
      <td>1650.842103</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>5.3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>0296748a-317a-47eb-bf94-e5dbbd78afc1</th>
      <td>buildingAofficeFloor2</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>8.4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>74ed0525-d8f9-4f36-b20f-1b8a2baf60f2</th>
      <td>buildingAofficeFloor3</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>11.5</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>ae0fb830-76df-4d91-82ed-4ed755fdec4b</th>
      <td>buildingAofficeFloor4</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>14.6</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>c1b696b1-cae0-49ed-a8ba-0e795438d3d2</th>
      <td>buildingAofficeFloor5</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>17.7</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>add95b48-71c3-40e7-9f35-7db604f3f9f0</th>
      <td>buildingAofficeFloor6</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>20.8</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>d8443e6d-9080-4154-89e3-29f0e98ed90a</th>
      <td>buildingAofficeFloor7</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>23.9</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>f8945b4f-6f59-4c5a-a83f-462a97f2dcc4</th>
      <td>buildingAofficeFloor8</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>27.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>b548b184-1643-4c23-9b14-9025aeda59c3</th>
      <td>buildingAofficeFloor9</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>30.1</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>e8048367-edd2-4a61-ae0f-fd878688c910</th>
      <td>buildingAofficeFloor10</td>
      <td>floor</td>
      <td>1448.922008</td>
      <td>1448.922008</td>
      <td>bfc1c272-665f-432d-a7b3-a4c955556e7f</td>
      <td>NaN</td>
      <td>33.2</td>
      <td>10.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also plot this as a hierarchical pie chart (a.k.a. ‘sunburst’ chart), or
a treemap:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sunburst</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">)</span>
<span class="n">treemap</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">treemap</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;treemap&quot;</span><span class="p">}]])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">sunburst</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">treemap</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;spatial_containment_chart.html&#39;</span>

<span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;assets/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;./</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="1600"
            src="./spatial_containment_chart.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
<section id="aggregating-a-financial-calculation">
<h4>Aggregating a (Financial) Calculation<a class="headerlink" href="#aggregating-a-financial-calculation" title="Permalink to this heading">#</a></h4>
<p>A more complex aggregation involves collecting specific cash <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s into
<code class="docutils literal notranslate"><span class="pre">Stream</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>/<code class="docutils literal notranslate"><span class="pre">Assembly</span></code>; for instance, we may want to aggregate all
revenues generated by lettable floorspace into their respective parent <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s,
in order to analyse or compare the performance of the scenario at different
resolutions.</p>
<p>We start by identifying which <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s are ‘floor’ types and have an area
measurement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">floors</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">filter_by_type</span><span class="p">(</span><span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;floor&#39;</span><span class="p">)</span>
<span class="n">floors</span> <span class="o">=</span> <span class="p">[</span><span class="n">floor</span> <span class="k">for</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">floors</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">floor</span><span class="p">,</span> <span class="s1">&#39;gfa&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>For each floor we can project a set of simple cash flows, in a similar manner
to <a class="reference internal" href="basic_dcf.html"><span class="doc std std-doc">A Basic DCF Valuation</span></a>.</p>
<p>First initialize our locale, and a set of parameters, including some around
area efficiency ratios, initial incomes per area, and growth rates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s1">&#39;en_au&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">registry</span>
<span class="n">currency</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">register_currency</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
<span class="n">period_type</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">efficiency_ratios</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=</span><span class="mf">0.825</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mf">0.675</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="p">)</span>
<span class="n">initial_income_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
<span class="n">pgi_growth_rates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=</span><span class="mf">.025</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mf">.075</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mf">.055</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
<span class="n">vacancy_rates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=</span><span class="mf">.075</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mf">.5</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mf">.02</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">revenue_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">efficiency_ratio</span><span class="o">=</span><span class="n">efficiency_ratios</span><span class="p">,</span>
        <span class="n">initial_income_per_area_pa</span><span class="o">=</span><span class="n">initial_income_per_area_pa</span><span class="p">,</span>
        <span class="n">pgi_growth_rate</span><span class="o">=</span><span class="n">pgi_growth_rates</span><span class="p">,</span>
        <span class="n">vacancy_rate</span><span class="o">=</span><span class="n">vacancy_rates</span><span class="p">,</span>
        <span class="p">))</span>
<span class="n">revenue_inputs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>efficiency_ratio</th>
      <th>initial_income_per_area_pa</th>
      <th>pgi_growth_rate</th>
      <th>vacancy_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>office</th>
      <td>0.825</td>
      <td>750</td>
      <td>0.025</td>
      <td>0.075</td>
    </tr>
    <tr>
      <th>retail</th>
      <td>0.675</td>
      <td>1000</td>
      <td>0.075</td>
      <td>0.500</td>
    </tr>
    <tr>
      <th>residential</th>
      <td>0.750</td>
      <td>600</td>
      <td>0.055</td>
      <td>0.020</td>
    </tr>
    <tr>
      <th>parking</th>
      <td>0.900</td>
      <td>0</td>
      <td>0.000</td>
      <td>0.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2001-01-01&#39;</span><span class="p">),</span>
    <span class="n">num_periods</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">period_type</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="streams-of-revenue-flows-per-entity">
<h5><code class="docutils literal notranslate"><span class="pre">Stream</span></code>s of Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:<a class="headerlink" href="#streams-of-revenue-flows-per-entity" title="Permalink to this heading">#</a></h5>
<p>It is now simple to construct a set of cash flows per <code class="docutils literal notranslate"><span class="pre">Entity</span></code> in our design
scenario. We will use a similar structure to the previous notebooks.</p>
<p>First we will define a general ‘Spans’ class that defines the time periods. This
can be used by any subsequent calculations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Spans</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_span</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">Span</span><span class="o">.</span><span class="n">from_num_periods</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Span to Calculate Reversion&#39;</span><span class="p">,</span>
            <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span>
            <span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">],</span>
            <span class="n">num_periods</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;num_periods&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_span</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">Span</span><span class="o">.</span><span class="n">from_num_periods</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Acquisition Span&#39;</span><span class="p">,</span>
            <span class="n">date</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">offset_date</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span>
                <span class="n">num_periods</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">]),</span>
            <span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">],</span>
            <span class="n">num_periods</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Span&#39;</span><span class="p">,</span>
            <span class="n">num_periods</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">],</span>
            <span class="n">bound</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we will define a <code class="docutils literal notranslate"><span class="pre">Revenues</span></code> class that holds the parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Revenues</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">spans</span><span class="p">:</span> <span class="n">Spans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans</span> <span class="o">=</span> <span class="n">spans</span>
</pre></div>
</div>
</div>
</div>
<p>And then we add Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@rk</span><span class="o">.</span><span class="n">update_class</span><span class="p">(</span><span class="n">Revenues</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Revenues</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgi</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Potential Gross Income&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_income&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pgi_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_index</span><span class="p">(</span><span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">])),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacancy</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Vacancy Allowance&#39;</span><span class="p">,</span>
            <span class="n">movements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pgi</span><span class="o">.</span><span class="n">movements</span> <span class="o">*</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;vacancy_rate&#39;</span><span class="p">],</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">egi</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Effective Gross Income&#39;</span><span class="p">,</span>
            <span class="n">flows</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pgi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacancy</span><span class="p">],</span>
            <span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now we need to add <code class="docutils literal notranslate"><span class="pre">Entity</span></code>-specific parameters to the parameters dictionary,
and run  the <code class="docutils literal notranslate"><span class="pre">init_spans()</span></code> and <code class="docutils literal notranslate"><span class="pre">init_flows()</span></code> methods per floor <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<p>(Note we place the resultant <code class="docutils literal notranslate"><span class="pre">Stream</span></code> in the <code class="docutils literal notranslate"><span class="pre">events</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">Entity</span></code>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spans</span> <span class="o">=</span> <span class="n">Spans</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">floors</span><span class="p">:</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">floor</span><span class="o">.</span><span class="n">get_relatives</span><span class="p">(</span>
        <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">,</span>
        <span class="n">outgoing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">assembly</span><span class="o">=</span><span class="n">spatial_containment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]</span>

    <span class="n">floor</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_income&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_income_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;gfa&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">efficiency_ratios</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span>
    <span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pgi_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi_growth_rates</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span>
    <span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;vacancy_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vacancy_rates</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span>

    <span class="c1"># floor.events = {}</span>

    <span class="n">revenues</span> <span class="o">=</span> <span class="n">Revenues</span><span class="p">(</span><span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span>
    <span class="n">revenues</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>

    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;pgi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revenues</span><span class="o">.</span><span class="n">pgi</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;vacancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revenues</span><span class="o">.</span><span class="n">vacancy</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;egi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revenues</span><span class="o">.</span><span class="n">egi</span>
    <span class="c1"># floor = {</span>
    <span class="c1">#     &#39;pgi&#39;: revenues.pgi,</span>
    <span class="c1">#     &#39;vacancy&#39;: revenues.vacancy,</span>
    <span class="c1">#     &#39;egi&#39;: revenues.egi,</span>
    <span class="c1">#     }</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="aggregating-by-parent-container">
<h5>Aggregating by Parent Container<a class="headerlink" href="#aggregating-by-parent-container" title="Permalink to this heading">#</a></h5>
<p>Since we have the “containment” hierarchy, we can aggregate the <code class="docutils literal notranslate"><span class="pre">Revenues</span></code> per
parent <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<p><em>Rangekeeper</em> provides some helper methods to assist in the aggregation of
<code class="docutils literal notranslate"><span class="pre">Stream</span></code>s and <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s; specifically, since the <code class="docutils literal notranslate"><span class="pre">Entity.aggregate()</span></code> method
updates a specified <code class="docutils literal notranslate"><span class="pre">Entity</span></code>’s property with a dictionary of subentity
properties, keyed by their respective <code class="docutils literal notranslate"><span class="pre">entityId</span></code>s, we can use the
<code class="docutils literal notranslate"><span class="pre">aggregate_flows()</span></code> function to support the collation of child <code class="docutils literal notranslate"><span class="pre">Entity</span></code>
<code class="docutils literal notranslate"><span class="pre">Flow</span></code>s into a single <code class="docutils literal notranslate"><span class="pre">Stream</span></code> in a new property label in the <code class="docutils literal notranslate"><span class="pre">Entity</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_egis</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Effective Gross Income&#39;</span><span class="p">,</span>
        <span class="n">period_type</span><span class="o">=</span><span class="n">period_type</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This function is passed into the <code class="docutils literal notranslate"><span class="pre">Entity.aggregate()</span></code> method as the <code class="docutils literal notranslate"><span class="pre">function</span></code>
parameter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_egis</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;egi&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can look at what the <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> method has produced for a single floor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">floors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Effective Gross Income&#39;
</pre></div>
</div>
</div>
</div>
<p>We can then inspect the <code class="docutils literal notranslate"><span class="pre">aggregate_egi</span></code> property of an <code class="docutils literal notranslate"><span class="pre">Entity</span></code>, which holds a
<code class="docutils literal notranslate"><span class="pre">Stream</span></code> of <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s (each coming from a child of that <code class="docutils literal notranslate"><span class="pre">Entity</span></code>). Let’s use the
office compartment in Building A:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingAoffice</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;buildingAoffice&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">buildingAoffice</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">buildingAoffice</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>buildingAoffice
</pre></div>
</div>
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">  date</th><th style="text-align: right;">  Effective Gross Income for a1fc1a28-1133-47f2-a8d9-58da817946c2 [buildingAofficeFloor1]</th><th style="text-align: right;">  Effective Gross Income for 0296748a-317a-47eb-bf94-e5dbbd78afc1 [buildingAofficeFloor2]</th><th style="text-align: right;">  Effective Gross Income for 74ed0525-d8f9-4f36-b20f-1b8a2baf60f2 [buildingAofficeFloor3]</th><th style="text-align: right;">  Effective Gross Income for ae0fb830-76df-4d91-82ed-4ed755fdec4b [buildingAofficeFloor4]</th><th style="text-align: right;">  Effective Gross Income for c1b696b1-cae0-49ed-a8ba-0e795438d3d2 [buildingAofficeFloor5]</th><th style="text-align: right;">  Effective Gross Income for add95b48-71c3-40e7-9f35-7db604f3f9f0 [buildingAofficeFloor6]</th><th style="text-align: right;">  Effective Gross Income for d8443e6d-9080-4154-89e3-29f0e98ed90a [buildingAofficeFloor7]</th><th style="text-align: right;">  Effective Gross Income for f8945b4f-6f59-4c5a-a83f-462a97f2dcc4 [buildingAofficeFloor8]</th><th style="text-align: right;">  Effective Gross Income for b548b184-1643-4c23-9b14-9025aeda59c3 [buildingAofficeFloor9]</th><th style="text-align: right;">  Effective Gross Income for e8048367-edd2-4a61-ae0f-fd878688c910 [buildingAofficeFloor10]</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">  2001</td><td style="text-align: right;">                                                                              $944,849.16</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                              $829,281.46</td><td style="text-align: right;">                                                                               $829,281.46</td></tr>
<tr><td style="text-align: right;">  2002</td><td style="text-align: right;">                                                                              $968,470.39</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                              $850,013.49</td><td style="text-align: right;">                                                                               $850,013.49</td></tr>
<tr><td style="text-align: right;">  2003</td><td style="text-align: right;">                                                                              $992,682.15</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                              $871,263.83</td><td style="text-align: right;">                                                                               $871,263.83</td></tr>
<tr><td style="text-align: right;">  2004</td><td style="text-align: right;">                                                                            $1,017,499.20</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                              $893,045.43</td><td style="text-align: right;">                                                                               $893,045.43</td></tr>
<tr><td style="text-align: right;">  2005</td><td style="text-align: right;">                                                                            $1,042,936.68</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                              $915,371.56</td><td style="text-align: right;">                                                                               $915,371.56</td></tr>
<tr><td style="text-align: right;">  2006</td><td style="text-align: right;">                                                                            $1,069,010.10</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                              $938,255.85</td><td style="text-align: right;">                                                                               $938,255.85</td></tr>
<tr><td style="text-align: right;">  2007</td><td style="text-align: right;">                                                                            $1,095,735.35</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                              $961,712.25</td><td style="text-align: right;">                                                                               $961,712.25</td></tr>
<tr><td style="text-align: right;">  2008</td><td style="text-align: right;">                                                                            $1,123,128.74</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                              $985,755.05</td><td style="text-align: right;">                                                                               $985,755.05</td></tr>
<tr><td style="text-align: right;">  2009</td><td style="text-align: right;">                                                                            $1,151,206.95</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                            $1,010,398.93</td><td style="text-align: right;">                                                                             $1,010,398.93</td></tr>
<tr><td style="text-align: right;">  2010</td><td style="text-align: right;">                                                                            $1,179,987.13</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                            $1,035,658.90</td><td style="text-align: right;">                                                                             $1,035,658.90</td></tr>
<tr><td style="text-align: right;">  2011</td><td style="text-align: right;">                                                                            $1,209,486.81</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                            $1,061,550.37</td><td style="text-align: right;">                                                                             $1,061,550.37</td></tr>
</tbody>
</table></div></div>
</div>
<p>We can also easily sum and collapse that aggregation, as it is a Stream`:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingAoffice</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Effective Gross Income for bfc1c272-665f-432d-a7b3-a4c955556e7f [buildingAoffice] Aggregation (sum)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2001-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $8,408,382.26</td></tr>
<tr><td style="text-align: right;">2002-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $8,618,591.82</td></tr>
<tr><td style="text-align: right;">2003-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $8,834,056.61</td></tr>
<tr><td style="text-align: right;">2004-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $9,054,908.03</td></tr>
<tr><td style="text-align: right;">2005-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $9,281,280.73</td></tr>
<tr><td style="text-align: right;">2006-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $9,513,312.75</td></tr>
<tr><td style="text-align: right;">2007-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $9,751,145.57</td></tr>
<tr><td style="text-align: right;">2008-12-31 00:00:00</td><td style="text-align: right;">                                                                                        $9,994,924.20</td></tr>
<tr><td style="text-align: right;">2009-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $10,244,797.31</td></tr>
<tr><td style="text-align: right;">2010-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $10,500,917.24</td></tr>
<tr><td style="text-align: right;">2011-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $10,763,440.17</td></tr>
</tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingAoffice</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Effective Gross Income for bfc1c272-665f-432d-a7b3-a4c955556e7f [buildingAoffice] Aggregation (sum)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2011-12-31 00:00:00</td><td style="text-align: right;">                                                                                      $104,965,756.69</td></tr>
</tbody>
</table></div></div>
</div>
<p>The above subtotals the Effective Gross Income (EGI) for the office space of
Building A over the period of the scenario.</p>
<p>We can then do this for all <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s in the graph, and plot the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sunburst</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">)</span>
<span class="n">treemap</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">treemap</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;treemap&quot;</span><span class="p">}]])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">sunburst</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">treemap</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;aggregate_egis_chart.html&#39;</span>
<span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;assets/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;./</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="1600"
            src="./aggregate_egis_chart.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
</section>
</section>
<section id="cost-generating-entities">
<h3>Cost-generating Entities<a class="headerlink" href="#cost-generating-entities" title="Permalink to this heading">#</a></h3>
<p>Let’s now do the same for the cost-generating <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s. While it is routine to
register revenue-generating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s with <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have lettable or
sellable floor space, the convention to also register all cost-generating
<code class="docutils literal notranslate"><span class="pre">Flow</span></code>s with only those same <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s is possibly only done out of convenience
rather than accuracy.</p>
<p>For example, both operating and capital expenses may be attributed to building
systems (e.g. maintenance, upgrading, &amp; replacement of MEP or facade
componentry) that are not coincident with the floor space they are servicing.
Ie, the convention to average (sub)total costs across (sub)total floor space may
be misleading, especially when attempting to compare different scenarios at
different resolutions (See <span id="id1">[<a class="reference internal" href="intro.html#id2" title="R. de Neufville and D. Geltner. Flexibility and Real Estate Valuation under Uncertainty: A Practical Guide for Developers. John Wiley &amp; Sons, Ltd, 2018. ISBN 9781119106470. URL: https://onlinelibrary.wiley.com/doi/abs/10.1002/9781119106470, arXiv:https://onlinelibrary.wiley.com/doi/pdf/10.1002/9781119106470, doi:https://doi.org/10.1002/9781119106470.">dNG18</a>]</span>, 5.4 Flaw of Averages).</p>
<p>By virtue of <em>Rangekeeper</em>’s multi-faceted approach to its object model, costs
can be attributed and aggregated to <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that are not spatially coincident
with the revenue-generating <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s; in the example design scenario, we will
use the ‘services’ relationship-type to register and aggregate some of these,
while space-specific costs will be registered and aggregated via spatial
containment:</p>
<section id="operational-and-capital-expenses-of-building-utilities-systems">
<h4>Operational and Capital Expenses of Building Utilities &amp; Systems<a class="headerlink" href="#operational-and-capital-expenses-of-building-utilities-systems" title="Permalink to this heading">#</a></h4>
<p>Of course, in a simplified model and without knowing design and engineering
details for the scenario, costs for operational and capital expenses will be
calculated from some proportional rate of spatial characteristics of the
building. In this example, we will use the following as simplifications of how
these types of costs may be calculated. Note that this is more a demonstration
of methodology, and in practice would adjust to real-world data about the
specific building systems and their costs.</p>
<ul class="simple">
<li><p>‘Floorplate-derived’ Operational and Capital Expenses will be calculated as a
function of the subtotal floorplate area of ‘building’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s. One could
think of this as representing the cost of operating the floor’s MEP, or
maintaining, repairing and upgrading elements on the floors themselves
(e.g. FF&amp;E)</p></li>
<li><p>‘Facade-derived’ Operational Expenses will be calculated as a function of the
surface area of ‘building’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>. This would represent the cost of facade
maintenance, repair or replacement.</p></li>
<li><p>‘Utility-derived’ Capital Expenses will be calculated as a function of the</p></li>
<li><p>volume of ‘utility’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s. This represents the cost of repairing and
upgrading the building’s MEP and transportation systems.</p></li>
</ul>
</section>
<section id="cost-flows-per-entity">
<h4>Cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code><a class="headerlink" href="#cost-flows-per-entity" title="Permalink to this heading">#</a></h4>
<p>There are some properties of <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that we need to produce before we can
calculate <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s off them. In this case we need to produce the facade area
for any <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have ‘perimeter’ and ‘ftf’ (Floor-to-Floor height)
properties:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregate Facade Areas:</span>
<span class="k">for</span> <span class="p">(</span><span class="n">entityId</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;perimeter&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;ftf&#39;</span><span class="p">):</span>
        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;facade_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;perimeter&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;ftf&#39;</span><span class="p">]</span>
<span class="n">spatial_containment</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;facade_area&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_facade_area&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now set up operational and capital costing parameters that are based off
either areas or volume, as well as growth rates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">floor_opex_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=-</span><span class="mi">150</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=-</span><span class="mi">225</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=-</span><span class="mi">125</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=-</span><span class="mi">65</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">facade_opex_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=-</span><span class="mi">25</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">opex_growth_rate</span> <span class="o">=</span> <span class="mf">0.035</span>
<span class="n">floor_capex_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">office</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=-</span><span class="mi">150</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=-</span><span class="mi">75</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">cores_capex_per_vol_pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
<span class="n">plant_capex_per_vol_pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
<span class="n">capex_growth_rate</span> <span class="o">=</span> <span class="mf">0.035</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can set up our <code class="docutils literal notranslate"><span class="pre">Costs</span></code> class to produce cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s and <code class="docutils literal notranslate"><span class="pre">Stream</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">spans</span><span class="p">:</span> <span class="n">Spans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans</span> <span class="o">=</span> <span class="n">spans</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@rk</span><span class="o">.</span><span class="n">update_class</span><span class="p">(</span><span class="n">Costs</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate_space_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">floor_opex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Floor-derived Operating Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_floor_opex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;opex_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_index</span><span class="p">(</span><span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">])),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">facade_opex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Facade-derived Operating Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_facade_opex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;opex_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_index</span><span class="p">(</span><span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">])),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Space Operating Expenses&#39;</span><span class="p">,</span>
            <span class="n">flows</span><span class="o">=</span><span class="p">[</span><span class="n">floor_opex</span><span class="p">,</span> <span class="n">facade_opex</span><span class="p">],</span>
            <span class="n">period_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;period_type&#39;</span><span class="p">])</span>

        <span class="n">floor_capex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Floor-derived Capital Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_floor_capex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_index</span><span class="p">(</span><span class="n">period_type</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">SEMIDECADE</span><span class="p">)),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floor_capex</span> <span class="o">=</span> <span class="n">floor_capex</span><span class="o">.</span><span class="n">trim_to_span</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="p">)</span>  <span class="c1"># This is to avoid issues with using &gt;yearly periodicity in projection</span>
</pre></div>
</div>
</div>
</div>
<p>We will split the generation of space-based costs from the utility-based costs,
as they will be applied to different <code class="docutils literal notranslate"><span class="pre">Entity</span></code> types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@rk</span><span class="o">.</span><span class="n">update_class</span><span class="p">(</span><span class="n">Costs</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate_utils_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">utils_capex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Utilities-derived Capital Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_utility_capex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                    <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]),</span>
                <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_index</span><span class="p">(</span><span class="n">period_type</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">periodicity</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">SEMIDECADE</span><span class="p">)),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utils_capex</span> <span class="o">=</span> <span class="n">utils_capex</span><span class="o">.</span><span class="n">trim_to_span</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="p">)</span>  <span class="c1"># This is to avoid issues with using &gt;yearly periodicity in projection</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can run the <code class="docutils literal notranslate"><span class="pre">Costs</span></code> class against ‘floor’ and ‘utilities’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">floors</span><span class="p">:</span>
    <span class="n">floor_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;initial_floor_opex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_opex_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">]</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;initial_facade_opex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facade_opex_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;subtotal_facade_area&#39;</span><span class="p">]</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;initial_floor_capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_capex_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">]</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;opex_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opex_growth_rate</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capex_growth_rate</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_params</span>

    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">floor</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="n">Costs</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">floor_params</span><span class="p">,</span>
        <span class="n">spans</span><span class="o">=</span><span class="n">spans</span><span class="p">)</span>
    <span class="n">costs</span><span class="o">.</span><span class="n">generate_space_costs</span><span class="p">()</span>

    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;opex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">opex</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">floor_capex</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utilities</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">filter_by_type</span><span class="p">(</span><span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;utilities&#39;</span><span class="p">,</span> <span class="n">is_assembly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">utilities</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{&#39;71fd4551-8e65-4e7a-8e2a-9d18e69146b0&#39;: Entity: buildingBcores (Type: utilities),
 &#39;55963d84-702d-423d-be05-c8bb6e88f517&#39;: Entity: buildingAcores (Type: utilities),
 &#39;8d9f92cf-5613-4de4-b99b-7681aa76b4cd&#39;: Entity: plinthplant (Type: utilities)}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">utility</span> <span class="ow">in</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">utility_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;plant&#39;</span> <span class="ow">in</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">utility_params</span><span class="p">[</span><span class="s1">&#39;initial_utility_capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant_capex_per_vol_pa</span> <span class="o">*</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;cores&#39;</span> <span class="ow">in</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">utility_params</span><span class="p">[</span><span class="s1">&#39;initial_utility_capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cores_capex_per_vol_pa</span> <span class="o">*</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="n">utility_params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capex_growth_rate</span>
    <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_params</span>

    <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="n">Costs</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">utility_params</span><span class="p">,</span>
        <span class="n">spans</span><span class="o">=</span><span class="n">spans</span><span class="p">)</span>
    <span class="n">costs</span><span class="o">.</span><span class="n">generate_utils_costs</span><span class="p">()</span>

    <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">utils_capex</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;capex&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Utilities-derived Capital Expenses</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2005-12-31 00:00:00</td><td style="text-align: right;">                        -$865,663.39</td></tr>
<tr><td style="text-align: right;">2010-12-31 00:00:00</td><td style="text-align: right;">                        -$895,961.61</td></tr>
</tbody>
</table></div></div>
</div>
<p>And finally aggregate them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_opex</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Operational Expenses&#39;</span><span class="p">,</span>
        <span class="n">period_type</span><span class="o">=</span><span class="n">period_type</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_opex</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;opex&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_capex</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Capital Expenses&#39;</span><span class="p">,</span>
        <span class="n">period_type</span><span class="o">=</span><span class="n">period_type</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_capex</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;capex&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we wish to see the ultimate aggregation of those costs, we can do so by
totalling them at their root <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingB</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;buildingB&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="n">buildingB</span><span class="p">[</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">  date</th><th style="text-align: right;">  Floor-derived Capital Expenses for c11f68da-0544-487b-9cb9-8a3a3a98a9b8 [buildingBresidentialFloor0]</th><th style="text-align: right;">  Floor-derived Capital Expenses for cfc3edf5-1e7d-4499-b25f-ee86ed013516 [buildingBresidentialFloor1]</th><th style="text-align: right;">  Floor-derived Capital Expenses for 3e158dd9-aa5d-47bb-bc13-4b3e6d328fe1 [buildingBresidentialFloor2]</th><th style="text-align: right;">  Floor-derived Capital Expenses for b8609a1e-b9f8-44a0-ab98-468ff247d753 [buildingBresidentialFloor3]</th><th style="text-align: right;">  Floor-derived Capital Expenses for f68d2f9b-13c5-42e2-9bca-1826f7eff481 [buildingBresidentialFloor4]</th><th style="text-align: right;">  Floor-derived Capital Expenses for ec086fbc-7b21-4958-b456-9bce6a883c98 [buildingBresidentialFloor5]</th><th style="text-align: right;">  Floor-derived Capital Expenses for 9ecaf92a-a90e-4572-a426-3ed392e0c28a [buildingBresidentialFloor6]</th><th style="text-align: right;">  Floor-derived Capital Expenses for 9a884f88-0627-4eb7-b1ec-80ea39b0a25b [buildingBresidentialFloor0]</th><th style="text-align: right;">  Floor-derived Capital Expenses for d7dd5233-b1c3-451f-ae90-5a80fed205bd [buildingBparkingFloor0]</th><th style="text-align: right;">  Floor-derived Capital Expenses for 4acebff3-f17b-44fb-ba29-6bc02053b329 [buildingBretailFloor0]</th><th style="text-align: right;">  Utilities-derived Capital Expenses for 71fd4551-8e65-4e7a-8e2a-9d18e69146b0 [buildingBcores]</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">  2005</td><td style="text-align: right;">                                                                                           -$57,445.62</td><td style="text-align: right;">                                                                                          -$177,079.20</td><td style="text-align: right;">                                                                                          -$177,079.20</td><td style="text-align: right;">                                                                                          -$151,196.70</td><td style="text-align: right;">                                                                                          -$151,196.70</td><td style="text-align: right;">                                                                                           -$65,626.12</td><td style="text-align: right;">                                                                                           -$65,626.12</td><td style="text-align: right;">                                                                                           -$12,955.58</td><td style="text-align: right;">                                                                                       -$58,908.24</td><td style="text-align: right;">                                                                                     -$122,397.52</td><td style="text-align: right;">                                                                                  -$865,663.39</td></tr>
<tr><td style="text-align: right;">  2006</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                             $0.00</td><td style="text-align: right;">                                                                                            $0.00</td><td style="text-align: right;">                                                                                         $0.00</td></tr>
<tr><td style="text-align: right;">  2007</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                             $0.00</td><td style="text-align: right;">                                                                                            $0.00</td><td style="text-align: right;">                                                                                         $0.00</td></tr>
<tr><td style="text-align: right;">  2008</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                             $0.00</td><td style="text-align: right;">                                                                                            $0.00</td><td style="text-align: right;">                                                                                         $0.00</td></tr>
<tr><td style="text-align: right;">  2009</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                                 $0.00</td><td style="text-align: right;">                                                                                             $0.00</td><td style="text-align: right;">                                                                                            $0.00</td><td style="text-align: right;">                                                                                         $0.00</td></tr>
<tr><td style="text-align: right;">  2010</td><td style="text-align: right;">                                                                                           -$59,456.22</td><td style="text-align: right;">                                                                                          -$183,276.97</td><td style="text-align: right;">                                                                                          -$183,276.97</td><td style="text-align: right;">                                                                                          -$156,488.59</td><td style="text-align: right;">                                                                                          -$156,488.59</td><td style="text-align: right;">                                                                                           -$67,923.03</td><td style="text-align: right;">                                                                                           -$67,923.03</td><td style="text-align: right;">                                                                                           -$13,409.02</td><td style="text-align: right;">                                                                                       -$60,970.03</td><td style="text-align: right;">                                                                                     -$126,681.43</td><td style="text-align: right;">                                                                                  -$895,961.61</td></tr>
</tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scenario_opex</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">scenario_capex</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario OPEX: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scenario_opex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario CAPEX: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scenario_capex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scenario OPEX: $-7,655,727.08
Scenario CAPEX: $-2,134,823.79
</pre></div>
</div>
</div>
</div>
<p>To get a sense check if this is reasonable, we can compare the opex and capex
to the PGI. First let’s aggregate the PGI for all <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_pgis</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Potential Gross Income&#39;</span><span class="p">,</span>
        <span class="n">period_type</span><span class="o">=</span><span class="n">period_type</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;pgi&#39;</span><span class="p">,</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_pgis</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_pgi&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>+And total it to the root <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scenario_pgi</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_pgi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario PGI: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scenario_pgi</span><span class="o">.</span><span class="n">movements</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scenario PGI: $16,942,743.44
</pre></div>
</div>
</div>
</div>
<p>Now we can calculate the Expenses ratios:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario OpEx as proportion of PGI: </span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">scenario_opex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">scenario_pgi</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scenario OpEx as proportion of PGI: 36.50%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario CapEx as proportion of PGI: </span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">scenario_capex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">scenario_pgi</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scenario CapEx as proportion of PGI: 10.18%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opex</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">)</span>
<span class="n">capex</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}]])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">opex</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">capex</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;aggregate_exp_chart.html&#39;</span>
<span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="s1">&#39;assets/</span><span class="si">{0}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;./</span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="1600"
            src="./aggregate_exp_chart.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<p>We can also calculate the net position of each <code class="docutils literal notranslate"><span class="pre">Entity</span></code> as its ‘Net Annual
Cashflow (NACF)’:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">flows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">flows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;egi&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">flows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;opex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">flows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;capex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">flows</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">)</span> <span class="k">else</span> <span class="n">flow</span> <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">flows</span><span class="p">))]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;nacf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Annual Cashflow&#39;</span><span class="p">,</span>
            <span class="n">flows</span><span class="o">=</span><span class="n">flows</span><span class="p">,</span>
            <span class="n">period_type</span><span class="o">=</span><span class="n">period_type</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_nacf</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Annual Cashflow&#39;</span><span class="p">,</span>
        <span class="n">period_type</span><span class="o">=</span><span class="n">period_type</span><span class="p">)</span>
<span class="n">scenario</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_opex</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;nacf&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_nacf&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scenario_nacf</span> <span class="o">=</span> <span class="n">scenario</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_nacf&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Scenario NACF: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scenario_nacf</span><span class="o">.</span><span class="n">total</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Scenario NACF: $109,837,612.44
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="load_design_scenario.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Loading a Design Scenario</p>
      </div>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-design-scenario">Load the Design Scenario</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-model-graph">Inspect the Model Graph</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assigning-and-aggregating-flows-per-entity">Assigning and Aggregating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revenue-producing-entities">Revenue-producing Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-aggregation">Simple Aggregation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-a-financial-calculation">Aggregating a (Financial) Calculation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#streams-of-revenue-flows-per-entity"><code class="docutils literal notranslate"><span class="pre">Stream</span></code>s of Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-by-parent-container">Aggregating by Parent Container</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-generating-entities">Cost-generating Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-and-capital-expenses-of-building-utilities-systems">Operational and Capital Expenses of Building Utilities &amp; Systems</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-flows-per-entity">Cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Daniel Fink
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>