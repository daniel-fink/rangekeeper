
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Driving a Financial Valuation from a Design &#8212; Rangekeeper</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'drive_model_from_design';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="&lt;no title&gt;" href="test_dotnet.html" />
    <link rel="prev" title="Loading a Design" href="load_design.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/rangekeeper.jpg" class="logo__image only-light" alt="Rangekeeper - Home"/>
    <script>document.write(`<img src="_static/rangekeeper.jpg" class="logo__image only-dark" alt="Rangekeeper - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Rangekeeper
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Real Estate Flexibility and Valuation under Uncertainty</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="basic_dcf.html">A Basic Discounted Cash Flow Valuation</a></li>
<li class="toctree-l1"><a class="reference internal" href="deterministic_scenarios.html">Deterministic Scenario Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="market_dynamics.html">Real Estate Pricing Factor Dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="flexibility_intro.html">Introduction to Modeling Flexibility</a></li>
<li class="toctree-l1"><a class="reference internal" href="flexibility_under_uncertainty.html">Flexibility under Uncertainty</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Using Rangekeeper in Examples</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="load_design.html">Loading a Design</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Driving a Financial Valuation from a Design</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/daniel-fink/rangekeeper/blob/main/walkthrough/drive_model_from_design.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/daniel-fink/rangekeeper" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/daniel-fink/rangekeeper/issues/new?title=Issue%20on%20page%20%2Fdrive_model_from_design.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/drive_model_from_design.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Driving a Financial Valuation from a Design</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-design">Load the Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-model-graph">Inspect the Model Graph</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assigning-and-aggregating-flows-per-entity">Assigning and Aggregating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revenue-producing-entities">Revenue-producing Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-aggregation">Simple Aggregation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-a-financial-calculation">Aggregating a (Financial) Calculation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#streams-of-revenue-flows-per-entity"><code class="docutils literal notranslate"><span class="pre">Stream</span></code>s of Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-by-parent-container">Aggregating by Parent Container</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-generating-entities">Cost-generating Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-and-capital-expenses-of-building-utilities-systems">Operational and Capital Expenses of Building Utilities &amp; Systems</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-flows-per-entity">Cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-overall-valuation">Calculating Overall Valuation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reversion">Reversion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#valuation">Valuation</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="driving-a-financial-valuation-from-a-design">
<h1>Driving a Financial Valuation from a Design<a class="headerlink" href="#driving-a-financial-valuation-from-a-design" title="Link to this heading">#</a></h1>
<p>As seen in
<a class="reference internal" href="load_design.html"><span class="std std-doc">Loading a Design</span></a>, a design’s object model (a
<a class="reference external" href="https://en.wikipedia.org/wiki/Knowledge_graph">knowledge graph</a> including all
its spatial and semantic relationships) can be loaded via Speckle from any of
Speckle’s supported <a class="reference external" href="https://speckle.guide/user/connectors.html">connectors</a>, so
long as those objects (<code class="docutils literal notranslate"><span class="pre">Entity</span></code>s and <code class="docutils literal notranslate"><span class="pre">Relationship</span></code>s) have been assigned.</p>
<p>In this notebook, we will demonstrate how to integrate financial modelling into
the object model (graph) in order to derive the financial valuation of a real
estate property from its spatial design.
This is done by calculating cash flows per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>, and then using the
<code class="docutils literal notranslate"><span class="pre">Relationship</span></code>s to aggregate those <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s into appropriate <code class="docutils literal notranslate"><span class="pre">Stream</span></code>s.</p>
<section id="load-the-design">
<h2>Load the Design<a class="headerlink" href="#load-the-design" title="Link to this heading">#</a></h2>
<p>We will use the same design as in the previous notebook.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">import</span> <span class="nn">locale</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">IFrame</span>
<span class="kn">import</span> <span class="nn">plotly.subplots</span>
<span class="kn">import</span> <span class="nn">plotly.offline</span> <span class="k">as</span> <span class="nn">py</span>

<span class="kn">import</span> <span class="nn">rangekeeper</span> <span class="k">as</span> <span class="nn">rk</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">speckle</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Speckle</span><span class="p">(</span>
    <span class="n">host</span><span class="o">=</span><span class="s2">&quot;speckle.xyz&quot;</span><span class="p">,</span>
    <span class="n">token</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SPECKLE_TOKEN&#39;</span><span class="p">))</span>
<span class="n">stream_id</span> <span class="o">=</span> <span class="s2">&quot;c0f66c35e3&quot;</span>
<span class="n">commit_id</span> <span class="o">=</span> <span class="n">speckle</span><span class="o">.</span><span class="n">get_latest_commit_id</span><span class="p">(</span><span class="n">stream_id</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="s2">&quot;https://speckle.xyz/embed?stream=</span><span class="si">{0}</span><span class="s2">&amp;commit=</span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">stream_id</span><span class="p">,</span> <span class="n">commit_id</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> SpeckleClient( server: https://speckle.xyz, authenticated: True )
</pre></div>
</div>
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="https://speckle.xyz/embed?stream=c0f66c35e3&commit=9a9670946f"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<section id="inspect-the-model-graph">
<h3>Inspect the Model Graph<a class="headerlink" href="#inspect-the-model-graph" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">speckle</span><span class="o">.</span><span class="n">get_commit</span><span class="p">(</span><span class="n">stream_id</span><span class="o">=</span><span class="n">stream_id</span><span class="p">)</span>
<span class="n">parsed</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Speckle</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="n">model</span><span class="p">[</span><span class="s1">&#39;@property&#39;</span><span class="p">])</span>
<span class="nb">property</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Speckle</span><span class="o">.</span><span class="n">to_rk</span><span class="p">(</span>
    <span class="n">bases</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">parsed</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;property&#39;</span><span class="p">,</span>
    <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;archetype&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning: Duplicate Entity 6496e279-88ca-49f4-b48c-6c0f156e0a58 [utilities] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
Warning: Duplicate Entity 6496e279-88ca-49f4-b48c-6c0f156e0a58 [utilities] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
Warning: Duplicate Entity 6496e279-88ca-49f4-b48c-6c0f156e0a58 [utilities] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
Warning: Duplicate Entity 2b51847e-ec54-415d-afa0-ce32d74c6144 [plinthparking] found.
Existing Entity is an Assembly while new Entity is not. Keeping Assembly.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">property</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;assets/</span><span class="si">{</span><span class="nb">property</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="nb">property</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>assets/property.html
</pre></div>
</div>
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="./property.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
</section>
<section id="assigning-and-aggregating-flows-per-entity">
<h2>Assigning and Aggregating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code><a class="headerlink" href="#assigning-and-aggregating-flows-per-entity" title="Link to this heading">#</a></h2>
<p>Now we can organise the two main categories of cash flows (costs and revenues)
according to the <code class="docutils literal notranslate"><span class="pre">Relationship</span></code> types in the design.</p>
<p>In this example, revenue-based cash flows are generated by <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have a
measureable floor area – in this case, anything that has a ‘gfa’ property.</p>
<p>We can query the graph to find them:</p>
<section id="revenue-producing-entities">
<h3>Revenue-producing Entities<a class="headerlink" href="#revenue-producing-entities" title="Link to this heading">#</a></h3>
<p>Revenue-producing <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s will be aggregated by their spatial containment. So
we can first slice our graph to a tree of nodes that have “contains”
relationships:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_containment</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">filter_by_type</span><span class="p">(</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;spatial_containment&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Note: we anticipate that the spatial decomposition is completely hierarchical
(i.e., no spaces overlap, which means no spaces have multiple parents). We can
check this by testing whether the containment graph is a “tree” (or
“arborescence”: see <a class="reference external" href="https://networkx.org/documentation/stable/reference/algorithms/tree.html#tree">NetworkX Tree</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nx</span><span class="o">.</span><span class="n">is_arborescence</span><span class="p">(</span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the spatial containment graph</span>
<span class="n">spatial_containment</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;assets/</span><span class="si">{</span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">.html&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>assets/property by spatiallyContains and None.html
</pre></div>
</div>
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="./property by spatiallyContains and None.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<section id="simple-aggregation">
<h4>Simple Aggregation<a class="headerlink" href="#simple-aggregation" title="Link to this heading">#</a></h4>
<p>Now that we have verified this, we can continue with a simple aggregation. We
wish to aggregate up through our hierarchy all <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have a Gross Floor
Area (‘gfa’) property. <em>Rangekeeper</em> provides defaults for the <code class="docutils literal notranslate"><span class="pre">Entity.aggregate()</span></code>
method for this, whereby a named property of any <code class="docutils literal notranslate"><span class="pre">Entity</span></code> is summed (numerical
addition) into its parent <code class="docutils literal notranslate"><span class="pre">Entity</span></code> against a specified label:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">property</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;gfa&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We can tabulate this by converting the graph to a pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>. Note that
the graph nodes (as witnessed in the DataFrame’s index and ‘parent’ column)
are GUID strings. Each of these have corresponding <code class="docutils literal notranslate"><span class="pre">Entity</span></code> objects, organised
via NetworkX’s Node Attributes. See <a class="reference external" href="https://networkx.org/documentation/stable/tutorial.html#what-to-use-as-nodes-and-edges">NetworkX Tutorial</a></p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">to_DataFrame</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;gfa&#39;</span><span class="p">,</span> <span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">,</span> <span class="s1">&#39;parent&#39;</span><span class="p">,</span> <span class="s1">&#39;use&#39;</span><span class="p">,</span> <span class="s1">&#39;ffl&#39;</span><span class="p">,</span> <span class="s1">&#39;number&#39;</span><span class="p">]]</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>name</th>
      <th>type</th>
      <th>gfa</th>
      <th>subtotal_gfa</th>
      <th>parent</th>
      <th>use</th>
      <th>ffl</th>
      <th>number</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>afe8e730-ad0f-4c2a-a15c-e249e4518fa8</th>
      <td>property</td>
      <td>property</td>
      <td>NaN</td>
      <td>42786.259115</td>
      <td>None</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>0a0a97ef-431d-471d-bc33-ace7e7df5fcb</th>
      <td>plinth</td>
      <td>building</td>
      <td>NaN</td>
      <td>12773.744211</td>
      <td>afe8e730-ad0f-4c2a-a15c-e249e4518fa8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>5ebb9736-5f18-4103-a5a4-040cd2e9b019</th>
      <td>buildingA</td>
      <td>building</td>
      <td>NaN</td>
      <td>16575.630074</td>
      <td>afe8e730-ad0f-4c2a-a15c-e249e4518fa8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>a1e00481-e51e-47c5-b629-8b214c0900bd</th>
      <td>buildingB</td>
      <td>building</td>
      <td>NaN</td>
      <td>13436.884829</td>
      <td>afe8e730-ad0f-4c2a-a15c-e249e4518fa8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6496e279-88ca-49f4-b48c-6c0f156e0a58</th>
      <td>utilities</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>afe8e730-ad0f-4c2a-a15c-e249e4518fa8</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2b51847e-ec54-415d-afa0-ce32d74c6144</th>
      <td>plinthparking</td>
      <td>space</td>
      <td>NaN</td>
      <td>12773.744211</td>
      <td>0a0a97ef-431d-471d-bc33-ace7e7df5fcb</td>
      <td>parking</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>938f4cf1-d307-4160-9538-d4bfa9583ad8</th>
      <td>plinthplant</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>0a0a97ef-431d-471d-bc33-ace7e7df5fcb</td>
      <td>plant</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>e84b8c35-fd4a-49fc-b4c9-e318a958685b</th>
      <td>plinthparkingFloor-2</td>
      <td>floor</td>
      <td>6386.872106</td>
      <td>6386.872106</td>
      <td>2b51847e-ec54-415d-afa0-ce32d74c6144</td>
      <td>NaN</td>
      <td>-5.9</td>
      <td>-2.0</td>
    </tr>
    <tr>
      <th>c3ebe151-1e0c-45c6-8852-7ea21f72290e</th>
      <td>plinthparkingFloor-1</td>
      <td>floor</td>
      <td>6386.872106</td>
      <td>6386.872106</td>
      <td>2b51847e-ec54-415d-afa0-ce32d74c6144</td>
      <td>NaN</td>
      <td>-2.8</td>
      <td>-1.0</td>
    </tr>
    <tr>
      <th>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</th>
      <td>buildingAhotel</td>
      <td>space</td>
      <td>NaN</td>
      <td>11716.690054</td>
      <td>5ebb9736-5f18-4103-a5a4-040cd2e9b019</td>
      <td>hotel</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1d0841bf-aa28-41d7-ba75-0ad0f3d57d21</th>
      <td>buildingAretail</td>
      <td>space</td>
      <td>NaN</td>
      <td>789.114895</td>
      <td>5ebb9736-5f18-4103-a5a4-040cd2e9b019</td>
      <td>retail</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7716632b-f43c-4ed2-9f84-26709361bbfe</th>
      <td>buildingAresidential</td>
      <td>space</td>
      <td>NaN</td>
      <td>2308.322369</td>
      <td>5ebb9736-5f18-4103-a5a4-040cd2e9b019</td>
      <td>residential</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>01aec121-ef19-4e6d-9f09-b2ce007b717d</th>
      <td>buildingAretail</td>
      <td>space</td>
      <td>NaN</td>
      <td>722.715820</td>
      <td>5ebb9736-5f18-4103-a5a4-040cd2e9b019</td>
      <td>retail</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>6f6b227b-b28b-4412-89bd-0a9bbc47164e</th>
      <td>buildingAparking</td>
      <td>space</td>
      <td>NaN</td>
      <td>1038.786936</td>
      <td>5ebb9736-5f18-4103-a5a4-040cd2e9b019</td>
      <td>parking</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>7eec5208-fc0e-4dfd-bd0b-b1d226b2e97e</th>
      <td>buildingAcores</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>5ebb9736-5f18-4103-a5a4-040cd2e9b019</td>
      <td>cores</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>bc265fcf-d0f6-4d22-8e92-d8f86f4d707a</th>
      <td>buildingAhotelFloor0</td>
      <td>floor</td>
      <td>111.690000</td>
      <td>111.690000</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>22851887-f9ee-4aa8-8755-bc021c3a3b30</th>
      <td>buildingAhotelFloor1</td>
      <td>floor</td>
      <td>1697.451572</td>
      <td>1697.451572</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>5.3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>d67cc046-9c03-4e43-b1b5-876417dbcdda</th>
      <td>buildingAhotelFloor2</td>
      <td>floor</td>
      <td>1270.128420</td>
      <td>1270.128420</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>8.4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>5f90565d-44c0-4de2-b510-d263599953f5</th>
      <td>buildingAhotelFloor3</td>
      <td>floor</td>
      <td>1068.208325</td>
      <td>1068.208325</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>11.5</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>f7b76e8b-93f0-47c6-8666-05c541c19e25</th>
      <td>buildingAhotelFloor4</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>14.6</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>9bdec185-a51b-4845-b746-ddcd3e3fa433</th>
      <td>buildingAhotelFloor5</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>17.7</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>250edc28-32de-4633-add0-a384305b5e87</th>
      <td>buildingAhotelFloor6</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>20.8</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>e4f25e01-0e9d-4fd2-b705-96d118802468</th>
      <td>buildingAhotelFloor7</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>23.9</td>
      <td>7.0</td>
    </tr>
    <tr>
      <th>9582fd3c-ce66-42c7-8675-39b04b7a4689</th>
      <td>buildingAhotelFloor8</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>27.0</td>
      <td>8.0</td>
    </tr>
    <tr>
      <th>9151983a-1344-4c88-81f3-76cd4ca8ec6d</th>
      <td>buildingAhotelFloor9</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>30.1</td>
      <td>9.0</td>
    </tr>
    <tr>
      <th>56eec388-d1bb-4de7-92a8-be8202d5be2d</th>
      <td>buildingAhotelFloor10</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>33.2</td>
      <td>10.0</td>
    </tr>
    <tr>
      <th>49d884ea-f590-46a3-a662-db5e73190848</th>
      <td>buildingAhotelFloor11</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>36.3</td>
      <td>11.0</td>
    </tr>
    <tr>
      <th>192fb1b2-fc6c-4b42-8135-45cbcbead777</th>
      <td>buildingAhotelFloor12</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>39.4</td>
      <td>12.0</td>
    </tr>
    <tr>
      <th>85305abb-0e6f-4c8f-bf27-553292e317e9</th>
      <td>buildingAhotelFloor13</td>
      <td>floor</td>
      <td>756.921174</td>
      <td>756.921174</td>
      <td>c0348c0f-a31f-421b-b6bc-0fe0d5ea947f</td>
      <td>NaN</td>
      <td>42.5</td>
      <td>13.0</td>
    </tr>
    <tr>
      <th>75c85658-55c8-4bd0-9d0c-c03a9b2c6169</th>
      <td>buildingAretailFloor0</td>
      <td>floor</td>
      <td>789.114895</td>
      <td>789.114895</td>
      <td>1d0841bf-aa28-41d7-ba75-0ad0f3d57d21</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>bf5a4444-6abd-4b89-b7a8-d758df5134fe</th>
      <td>buildingAresidentialFloor0</td>
      <td>floor</td>
      <td>57.900000</td>
      <td>57.900000</td>
      <td>7716632b-f43c-4ed2-9f84-26709361bbfe</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>dbf25b07-6f85-45bb-905c-de5b8562f5e7</th>
      <td>buildingAresidentialFloor1</td>
      <td>floor</td>
      <td>750.140790</td>
      <td>750.140790</td>
      <td>7716632b-f43c-4ed2-9f84-26709361bbfe</td>
      <td>NaN</td>
      <td>5.3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>507e4ef2-fe13-44d7-af5f-bcf717b3de53</th>
      <td>buildingAresidentialFloor2</td>
      <td>floor</td>
      <td>750.140790</td>
      <td>750.140790</td>
      <td>7716632b-f43c-4ed2-9f84-26709361bbfe</td>
      <td>NaN</td>
      <td>8.4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>bb815059-7516-45df-8fac-16f0e62242f3</th>
      <td>buildingAresidentialFloor3</td>
      <td>floor</td>
      <td>750.140790</td>
      <td>750.140790</td>
      <td>7716632b-f43c-4ed2-9f84-26709361bbfe</td>
      <td>NaN</td>
      <td>11.5</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>d45316af-5763-4b39-8e39-dc7645c39ec2</th>
      <td>buildingAretailFloor0</td>
      <td>floor</td>
      <td>722.715820</td>
      <td>722.715820</td>
      <td>01aec121-ef19-4e6d-9f09-b2ce007b717d</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>99dae6a3-d102-4525-9f3a-b8ee50a9c45f</th>
      <td>buildingAparkingFloor0</td>
      <td>floor</td>
      <td>1038.786936</td>
      <td>1038.786936</td>
      <td>6f6b227b-b28b-4412-89bd-0a9bbc47164e</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>e9acc93a-6f25-4179-97b3-594d1927565a</th>
      <td>buildingBresidential</td>
      <td>space</td>
      <td>NaN</td>
      <td>11442.736624</td>
      <td>a1e00481-e51e-47c5-b629-8b214c0900bd</td>
      <td>residential</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>eb1a8e6c-abf7-4fde-be66-b79a53eb7d52</th>
      <td>buildingBparking</td>
      <td>space</td>
      <td>NaN</td>
      <td>1178.164752</td>
      <td>a1e00481-e51e-47c5-b629-8b214c0900bd</td>
      <td>parking</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>34e63754-df1f-4c4d-b480-afa4109b3a5a</th>
      <td>buildingBretail</td>
      <td>space</td>
      <td>NaN</td>
      <td>815.983454</td>
      <td>a1e00481-e51e-47c5-b629-8b214c0900bd</td>
      <td>retail</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>cb5a02f7-b1b9-4a32-95b8-bbb70a946230</th>
      <td>buildingBcores</td>
      <td>utilities</td>
      <td>NaN</td>
      <td>0.000000</td>
      <td>a1e00481-e51e-47c5-b629-8b214c0900bd</td>
      <td>cores</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>0c018f4e-85d1-45ca-a83a-e3047e63ea6e</th>
      <td>buildingBresidentialFloor0</td>
      <td>floor</td>
      <td>765.941631</td>
      <td>765.941631</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>5ffdc26b-ed78-45e7-95a7-93114f38437b</th>
      <td>buildingBresidentialFloor1</td>
      <td>floor</td>
      <td>2361.056035</td>
      <td>2361.056035</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>5.3</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>15c0f8fb-5a62-4f60-94fc-5f1ea1a79f76</th>
      <td>buildingBresidentialFloor2</td>
      <td>floor</td>
      <td>2361.056035</td>
      <td>2361.056035</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>8.4</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>aece3428-b220-4ced-a819-15cdb72166aa</th>
      <td>buildingBresidentialFloor3</td>
      <td>floor</td>
      <td>2015.956035</td>
      <td>2015.956035</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>11.5</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1b966f89-f491-425e-9da1-ad0ad124cae4</th>
      <td>buildingBresidentialFloor4</td>
      <td>floor</td>
      <td>2015.956035</td>
      <td>2015.956035</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>14.6</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>f3ff41c9-c6e6-4bcb-8d36-c7acfbecf839</th>
      <td>buildingBresidentialFloor5</td>
      <td>floor</td>
      <td>875.014900</td>
      <td>875.014900</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>17.7</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>1df6c7b8-7e0a-4347-b94c-82324a5c4765</th>
      <td>buildingBresidentialFloor6</td>
      <td>floor</td>
      <td>875.014900</td>
      <td>875.014900</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>20.8</td>
      <td>6.0</td>
    </tr>
    <tr>
      <th>7f876f6b-5eef-44d0-b9be-39b08176e2e4</th>
      <td>buildingBresidentialFloor0</td>
      <td>floor</td>
      <td>172.741054</td>
      <td>172.741054</td>
      <td>e9acc93a-6f25-4179-97b3-594d1927565a</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3623f3aa-9226-46d1-9e2f-b3e82e0f187f</th>
      <td>buildingBparkingFloor0</td>
      <td>floor</td>
      <td>1178.164752</td>
      <td>1178.164752</td>
      <td>eb1a8e6c-abf7-4fde-be66-b79a53eb7d52</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>bb756739-0f7c-43ec-874a-ec0def2ca9e4</th>
      <td>buildingBretailFloor0</td>
      <td>floor</td>
      <td>815.983454</td>
      <td>815.983454</td>
      <td>34e63754-df1f-4c4d-b480-afa4109b3a5a</td>
      <td>NaN</td>
      <td>0.3</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can also plot this as a hierarchical pie chart (a.k.a. ‘sunburst’ chart), or
a treemap:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sunburst</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">)</span>
<span class="n">treemap</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">treemap</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;treemap&quot;</span><span class="p">}]],</span>
    <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Gross Floor Area - Sunburst Plot&#39;</span><span class="p">,</span> <span class="s1">&#39;Gross Floor Area - Treemap Plot&#39;</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">sunburst</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">treemap</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;spatial_containment_chart.html&#39;</span>

<span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;assets/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="1600"
            src="./spatial_containment_chart.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
<section id="aggregating-a-financial-calculation">
<h4>Aggregating a (Financial) Calculation<a class="headerlink" href="#aggregating-a-financial-calculation" title="Link to this heading">#</a></h4>
<p>A more complex aggregation involves collecting specific cash <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s into
<code class="docutils literal notranslate"><span class="pre">Stream</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>/<code class="docutils literal notranslate"><span class="pre">Assembly</span></code>; for instance, we may want to aggregate all
revenues generated by lettable floorspace into their respective parent <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s,
in order to analyse or compare the performance of the design at different
resolutions.</p>
<p>We start by identifying which <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s are ‘floor’ types and have an area
measurement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">floors</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">filter_by_type</span><span class="p">(</span><span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;floor&#39;</span><span class="p">)</span>
<span class="n">floors</span> <span class="o">=</span> <span class="p">[</span><span class="n">floor</span> <span class="k">for</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">floors</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">floor</span><span class="p">,</span> <span class="s1">&#39;gfa&#39;</span><span class="p">)]</span>
</pre></div>
</div>
</div>
</div>
<p>For each floor we can project a set of simple cash flows, in a similar manner
to <a class="reference internal" href="basic_dcf.html"><span class="std std-doc">A Basic DCF Valuation</span></a>.</p>
<p>First initialize our locale, and a set of parameters, including some around
area efficiency ratios, initial incomes per area, and growth rates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">locale</span><span class="o">.</span><span class="n">setlocale</span><span class="p">(</span><span class="n">locale</span><span class="o">.</span><span class="n">LC_ALL</span><span class="p">,</span> <span class="s1">&#39;en_au&#39;</span><span class="p">)</span>
<span class="n">units</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">Index</span><span class="o">.</span><span class="n">registry</span>
<span class="n">currency</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">measure</span><span class="o">.</span><span class="n">register_currency</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="n">units</span><span class="p">)</span>
<span class="n">frequency</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">efficiency_ratios</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mf">0.675</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mf">0.9</span>
    <span class="p">)</span>
<span class="n">initial_income_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=</span><span class="mi">750</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mi">600</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
<span class="n">pgi_growth_rates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=</span><span class="mf">.035</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mf">.075</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mf">.055</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mi">0</span>
    <span class="p">)</span>
<span class="n">vacancy_rates</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=</span><span class="mf">.025</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=</span><span class="mf">.075</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=</span><span class="mf">.015</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">revenue_inputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="n">efficiency_ratio</span><span class="o">=</span><span class="n">efficiency_ratios</span><span class="p">,</span>
        <span class="n">initial_income_per_area_pa</span><span class="o">=</span><span class="n">initial_income_per_area_pa</span><span class="p">,</span>
        <span class="n">pgi_growth_rate</span><span class="o">=</span><span class="n">pgi_growth_rates</span><span class="p">,</span>
        <span class="n">vacancy_rate</span><span class="o">=</span><span class="n">vacancy_rates</span><span class="p">,</span>
        <span class="p">))</span>
<span class="n">revenue_inputs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>efficiency_ratio</th>
      <th>initial_income_per_area_pa</th>
      <th>pgi_growth_rate</th>
      <th>vacancy_rate</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>hotel</th>
      <td>0.800</td>
      <td>750</td>
      <td>0.035</td>
      <td>0.025</td>
    </tr>
    <tr>
      <th>retail</th>
      <td>0.675</td>
      <td>1000</td>
      <td>0.075</td>
      <td>0.075</td>
    </tr>
    <tr>
      <th>residential</th>
      <td>0.750</td>
      <td>600</td>
      <td>0.055</td>
      <td>0.015</td>
    </tr>
    <tr>
      <th>parking</th>
      <td>0.900</td>
      <td>0</td>
      <td>0.000</td>
      <td>0.000</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">start_date</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s1">&#39;2001-01-01&#39;</span><span class="p">),</span>
    <span class="n">num_periods</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">frequency</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="streams-of-revenue-flows-per-entity">
<h5><code class="docutils literal notranslate"><span class="pre">Stream</span></code>s of Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:<a class="headerlink" href="#streams-of-revenue-flows-per-entity" title="Link to this heading">#</a></h5>
<p>We can now construct a set of cash flows per <code class="docutils literal notranslate"><span class="pre">Entity</span></code> in our design for our
asset. We will use a similar structure to the previous notebooks.</p>
<p>First we will define a general ‘Spans’ class that defines the time periods. This
can be used by any subsequent calculations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Spans</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_span</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">Span</span><span class="o">.</span><span class="n">from_duration</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Span to Calculate Reversion&#39;</span><span class="p">,</span>
            <span class="n">date</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span>
            <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">],</span>
            <span class="n">amount</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;num_periods&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acq_span</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">Span</span><span class="o">.</span><span class="n">from_duration</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Acquisition Span&#39;</span><span class="p">,</span>
            <span class="n">date</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span>
                <span class="n">amount</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">]),</span>
            <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Span&#39;</span><span class="p">,</span>
            <span class="n">amount</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Then, we will define a <code class="docutils literal notranslate"><span class="pre">Revenues</span></code> class that holds the parameters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Revenues</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">spans</span><span class="p">:</span> <span class="n">Spans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans</span> <span class="o">=</span> <span class="n">spans</span>
</pre></div>
</div>
</div>
</div>
<p>And then we add Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@rk</span><span class="o">.</span><span class="n">update_class</span><span class="p">(</span><span class="n">Revenues</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Revenues</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pgi</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Potential Gross Income&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_income&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pgi_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_sequence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vacancy</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Vacancy Allowance&#39;</span><span class="p">,</span>
            <span class="n">movements</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pgi</span><span class="o">.</span><span class="n">movements</span> <span class="o">*</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;vacancy_rate&#39;</span><span class="p">],</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">egi</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Effective Gross Income&#39;</span><span class="p">,</span>
            <span class="n">flows</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pgi</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vacancy</span><span class="p">],</span>
            <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Now we need to add <code class="docutils literal notranslate"><span class="pre">Entity</span></code>-specific parameters to the parameters dictionary,
and run  the <code class="docutils literal notranslate"><span class="pre">init_spans()</span></code> and <code class="docutils literal notranslate"><span class="pre">init_flows()</span></code> methods per floor <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<p>(Note we place the resultant <code class="docutils literal notranslate"><span class="pre">Stream</span></code> in the <code class="docutils literal notranslate"><span class="pre">events</span></code> attribute of the <code class="docutils literal notranslate"><span class="pre">Entity</span></code>)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spans</span> <span class="o">=</span> <span class="n">Spans</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">floors</span><span class="p">:</span>
    <span class="n">parent</span> <span class="o">=</span> <span class="n">floor</span><span class="o">.</span><span class="n">get_relatives</span><span class="p">(</span>
        <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">,</span>
        <span class="n">outgoing</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">assembly</span><span class="o">=</span><span class="n">spatial_containment</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]</span>

    <span class="n">floor</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_income&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_income_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;gfa&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">efficiency_ratios</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span>
    <span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;pgi_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pgi_growth_rates</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span>
    <span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;vacancy_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vacancy_rates</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span>

    <span class="n">revenues</span> <span class="o">=</span> <span class="n">Revenues</span><span class="p">(</span><span class="n">floor</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">spans</span><span class="p">)</span>
    <span class="n">revenues</span><span class="o">.</span><span class="n">generate</span><span class="p">()</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;pgi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revenues</span><span class="o">.</span><span class="n">pgi</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;vacancy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revenues</span><span class="o">.</span><span class="n">vacancy</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;egi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">revenues</span><span class="o">.</span><span class="n">egi</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="aggregating-by-parent-container">
<h5>Aggregating by Parent Container<a class="headerlink" href="#aggregating-by-parent-container" title="Link to this heading">#</a></h5>
<p>Since we have the “containment” hierarchy, we can aggregate the <code class="docutils literal notranslate"><span class="pre">Revenues</span></code> per
parent <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<p><em>Rangekeeper</em> provides some helper methods to assist in the aggregation of
<code class="docutils literal notranslate"><span class="pre">Stream</span></code>s and <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s; specifically, since the <code class="docutils literal notranslate"><span class="pre">Entity.aggregate()</span></code> method
updates a specified <code class="docutils literal notranslate"><span class="pre">Entity</span></code>’s property with a dictionary of subentity
properties, keyed by their respective <code class="docutils literal notranslate"><span class="pre">entityId</span></code>s, we can use the
<code class="docutils literal notranslate"><span class="pre">aggregate_flows()</span></code> function to support the collation of child <code class="docutils literal notranslate"><span class="pre">Entity</span></code>
<code class="docutils literal notranslate"><span class="pre">Flow</span></code>s into a single <code class="docutils literal notranslate"><span class="pre">Stream</span></code> in a new property label in the <code class="docutils literal notranslate"><span class="pre">Entity</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_egis</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Effective Gross Income&#39;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This function is passed into the <code class="docutils literal notranslate"><span class="pre">Entity.aggregate()</span></code> method as the <code class="docutils literal notranslate"><span class="pre">function</span></code>
parameter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">property</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_egis</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;egi&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can look at what the <code class="docutils literal notranslate"><span class="pre">aggregate</span></code> method has produced for a single floor:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">floors</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;Effective Gross Income&#39;
</pre></div>
</div>
</div>
</div>
<p>We can then inspect the <code class="docutils literal notranslate"><span class="pre">aggregate_egi</span></code> property of an <code class="docutils literal notranslate"><span class="pre">Entity</span></code>, which holds a
<code class="docutils literal notranslate"><span class="pre">Stream</span></code> of <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s (each coming from a child of that <code class="docutils literal notranslate"><span class="pre">Entity</span></code>). Let’s use the
hotel compartment in Building A:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingAhotel</span> <span class="o">=</span> <span class="p">[</span><span class="n">e</span> <span class="k">for</span> <span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span> <span class="ow">in</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;buildingAhotel&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">buildingAhotel</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">buildingAhotel</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>buildingAhotel
</pre></div>
</div>
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">  date</th><th style="text-align: right;">  Effective Gross Income for bc265fcf-d0f6-4d22-8e92-d8f86f4d707a [buildingAhotelFloor0]</th><th style="text-align: right;">  Effective Gross Income for 22851887-f9ee-4aa8-8755-bc021c3a3b30 [buildingAhotelFloor1]</th><th style="text-align: right;">  Effective Gross Income for d67cc046-9c03-4e43-b1b5-876417dbcdda [buildingAhotelFloor2]</th><th style="text-align: right;">  Effective Gross Income for 5f90565d-44c0-4de2-b510-d263599953f5 [buildingAhotelFloor3]</th><th style="text-align: right;">  Effective Gross Income for f7b76e8b-93f0-47c6-8666-05c541c19e25 [buildingAhotelFloor4]</th><th style="text-align: right;">  Effective Gross Income for 9bdec185-a51b-4845-b746-ddcd3e3fa433 [buildingAhotelFloor5]</th><th style="text-align: right;">  Effective Gross Income for 250edc28-32de-4633-add0-a384305b5e87 [buildingAhotelFloor6]</th><th style="text-align: right;">  Effective Gross Income for e4f25e01-0e9d-4fd2-b705-96d118802468 [buildingAhotelFloor7]</th><th style="text-align: right;">  Effective Gross Income for 9582fd3c-ce66-42c7-8675-39b04b7a4689 [buildingAhotelFloor8]</th><th style="text-align: right;">  Effective Gross Income for 9151983a-1344-4c88-81f3-76cd4ca8ec6d [buildingAhotelFloor9]</th><th style="text-align: right;">  Effective Gross Income for 56eec388-d1bb-4de7-92a8-be8202d5be2d [buildingAhotelFloor10]</th><th style="text-align: right;">  Effective Gross Income for 49d884ea-f590-46a3-a662-db5e73190848 [buildingAhotelFloor11]</th><th style="text-align: right;">  Effective Gross Income for 192fb1b2-fc6c-4b42-8135-45cbcbead777 [buildingAhotelFloor12]</th><th style="text-align: right;">  Effective Gross Income for 85305abb-0e6f-4c8f-bf27-553292e317e9 [buildingAhotelFloor13]</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">  2001</td><td style="text-align: right;">                                                                              $65,338.65</td><td style="text-align: right;">                                                                             $993,009.17</td><td style="text-align: right;">                                                                             $743,025.13</td><td style="text-align: right;">                                                                             $624,901.87</td><td style="text-align: right;">                                                                             $442,798.89</td><td style="text-align: right;">                                                                             $442,798.89</td><td style="text-align: right;">                                                                             $442,798.89</td><td style="text-align: right;">                                                                             $442,798.89</td><td style="text-align: right;">                                                                             $442,798.89</td><td style="text-align: right;">                                                                             $442,798.89</td><td style="text-align: right;">                                                                              $442,798.89</td><td style="text-align: right;">                                                                              $442,798.89</td><td style="text-align: right;">                                                                              $442,798.89</td><td style="text-align: right;">                                                                              $442,798.89</td></tr>
<tr><td style="text-align: right;">  2002</td><td style="text-align: right;">                                                                              $67,625.50</td><td style="text-align: right;">                                                                           $1,027,764.49</td><td style="text-align: right;">                                                                             $769,031.00</td><td style="text-align: right;">                                                                             $646,773.44</td><td style="text-align: right;">                                                                             $458,296.85</td><td style="text-align: right;">                                                                             $458,296.85</td><td style="text-align: right;">                                                                             $458,296.85</td><td style="text-align: right;">                                                                             $458,296.85</td><td style="text-align: right;">                                                                             $458,296.85</td><td style="text-align: right;">                                                                             $458,296.85</td><td style="text-align: right;">                                                                              $458,296.85</td><td style="text-align: right;">                                                                              $458,296.85</td><td style="text-align: right;">                                                                              $458,296.85</td><td style="text-align: right;">                                                                              $458,296.85</td></tr>
<tr><td style="text-align: right;">  2003</td><td style="text-align: right;">                                                                              $69,992.40</td><td style="text-align: right;">                                                                           $1,063,736.25</td><td style="text-align: right;">                                                                             $795,947.09</td><td style="text-align: right;">                                                                             $669,410.51</td><td style="text-align: right;">                                                                             $474,337.24</td><td style="text-align: right;">                                                                             $474,337.24</td><td style="text-align: right;">                                                                             $474,337.24</td><td style="text-align: right;">                                                                             $474,337.24</td><td style="text-align: right;">                                                                             $474,337.24</td><td style="text-align: right;">                                                                             $474,337.24</td><td style="text-align: right;">                                                                              $474,337.24</td><td style="text-align: right;">                                                                              $474,337.24</td><td style="text-align: right;">                                                                              $474,337.24</td><td style="text-align: right;">                                                                              $474,337.24</td></tr>
<tr><td style="text-align: right;">  2004</td><td style="text-align: right;">                                                                              $72,442.13</td><td style="text-align: right;">                                                                           $1,100,967.02</td><td style="text-align: right;">                                                                             $823,805.24</td><td style="text-align: right;">                                                                             $692,839.87</td><td style="text-align: right;">                                                                             $490,939.04</td><td style="text-align: right;">                                                                             $490,939.04</td><td style="text-align: right;">                                                                             $490,939.04</td><td style="text-align: right;">                                                                             $490,939.04</td><td style="text-align: right;">                                                                             $490,939.04</td><td style="text-align: right;">                                                                             $490,939.04</td><td style="text-align: right;">                                                                              $490,939.04</td><td style="text-align: right;">                                                                              $490,939.04</td><td style="text-align: right;">                                                                              $490,939.04</td><td style="text-align: right;">                                                                              $490,939.04</td></tr>
<tr><td style="text-align: right;">  2005</td><td style="text-align: right;">                                                                              $74,977.60</td><td style="text-align: right;">                                                                           $1,139,500.86</td><td style="text-align: right;">                                                                             $852,638.42</td><td style="text-align: right;">                                                                             $717,089.27</td><td style="text-align: right;">                                                                             $508,121.91</td><td style="text-align: right;">                                                                             $508,121.91</td><td style="text-align: right;">                                                                             $508,121.91</td><td style="text-align: right;">                                                                             $508,121.91</td><td style="text-align: right;">                                                                             $508,121.91</td><td style="text-align: right;">                                                                             $508,121.91</td><td style="text-align: right;">                                                                              $508,121.91</td><td style="text-align: right;">                                                                              $508,121.91</td><td style="text-align: right;">                                                                              $508,121.91</td><td style="text-align: right;">                                                                              $508,121.91</td></tr>
<tr><td style="text-align: right;">  2006</td><td style="text-align: right;">                                                                              $77,601.82</td><td style="text-align: right;">                                                                           $1,179,383.39</td><td style="text-align: right;">                                                                             $882,480.77</td><td style="text-align: right;">                                                                             $742,187.39</td><td style="text-align: right;">                                                                             $525,906.17</td><td style="text-align: right;">                                                                             $525,906.17</td><td style="text-align: right;">                                                                             $525,906.17</td><td style="text-align: right;">                                                                             $525,906.17</td><td style="text-align: right;">                                                                             $525,906.17</td><td style="text-align: right;">                                                                             $525,906.17</td><td style="text-align: right;">                                                                              $525,906.17</td><td style="text-align: right;">                                                                              $525,906.17</td><td style="text-align: right;">                                                                              $525,906.17</td><td style="text-align: right;">                                                                              $525,906.17</td></tr>
<tr><td style="text-align: right;">  2007</td><td style="text-align: right;">                                                                              $80,317.88</td><td style="text-align: right;">                                                                           $1,220,661.81</td><td style="text-align: right;">                                                                             $913,367.59</td><td style="text-align: right;">                                                                             $768,163.95</td><td style="text-align: right;">                                                                             $544,312.89</td><td style="text-align: right;">                                                                             $544,312.89</td><td style="text-align: right;">                                                                             $544,312.89</td><td style="text-align: right;">                                                                             $544,312.89</td><td style="text-align: right;">                                                                             $544,312.89</td><td style="text-align: right;">                                                                             $544,312.89</td><td style="text-align: right;">                                                                              $544,312.89</td><td style="text-align: right;">                                                                              $544,312.89</td><td style="text-align: right;">                                                                              $544,312.89</td><td style="text-align: right;">                                                                              $544,312.89</td></tr>
<tr><td style="text-align: right;">  2008</td><td style="text-align: right;">                                                                              $83,129.01</td><td style="text-align: right;">                                                                           $1,263,384.97</td><td style="text-align: right;">                                                                             $945,335.46</td><td style="text-align: right;">                                                                             $795,049.69</td><td style="text-align: right;">                                                                             $563,363.84</td><td style="text-align: right;">                                                                             $563,363.84</td><td style="text-align: right;">                                                                             $563,363.84</td><td style="text-align: right;">                                                                             $563,363.84</td><td style="text-align: right;">                                                                             $563,363.84</td><td style="text-align: right;">                                                                             $563,363.84</td><td style="text-align: right;">                                                                              $563,363.84</td><td style="text-align: right;">                                                                              $563,363.84</td><td style="text-align: right;">                                                                              $563,363.84</td><td style="text-align: right;">                                                                              $563,363.84</td></tr>
<tr><td style="text-align: right;">  2009</td><td style="text-align: right;">                                                                              $86,038.52</td><td style="text-align: right;">                                                                           $1,307,603.45</td><td style="text-align: right;">                                                                             $978,422.20</td><td style="text-align: right;">                                                                             $822,876.43</td><td style="text-align: right;">                                                                             $583,081.58</td><td style="text-align: right;">                                                                             $583,081.58</td><td style="text-align: right;">                                                                             $583,081.58</td><td style="text-align: right;">                                                                             $583,081.58</td><td style="text-align: right;">                                                                             $583,081.58</td><td style="text-align: right;">                                                                             $583,081.58</td><td style="text-align: right;">                                                                              $583,081.58</td><td style="text-align: right;">                                                                              $583,081.58</td><td style="text-align: right;">                                                                              $583,081.58</td><td style="text-align: right;">                                                                              $583,081.58</td></tr>
<tr><td style="text-align: right;">  2010</td><td style="text-align: right;">                                                                              $89,049.87</td><td style="text-align: right;">                                                                           $1,353,369.57</td><td style="text-align: right;">                                                                           $1,012,666.98</td><td style="text-align: right;">                                                                             $851,677.11</td><td style="text-align: right;">                                                                             $603,489.43</td><td style="text-align: right;">                                                                             $603,489.43</td><td style="text-align: right;">                                                                             $603,489.43</td><td style="text-align: right;">                                                                             $603,489.43</td><td style="text-align: right;">                                                                             $603,489.43</td><td style="text-align: right;">                                                                             $603,489.43</td><td style="text-align: right;">                                                                              $603,489.43</td><td style="text-align: right;">                                                                              $603,489.43</td><td style="text-align: right;">                                                                              $603,489.43</td><td style="text-align: right;">                                                                              $603,489.43</td></tr>
<tr><td style="text-align: right;">  2011</td><td style="text-align: right;">                                                                              $92,166.62</td><td style="text-align: right;">                                                                           $1,400,737.50</td><td style="text-align: right;">                                                                           $1,048,110.32</td><td style="text-align: right;">                                                                             $881,485.80</td><td style="text-align: right;">                                                                             $624,611.56</td><td style="text-align: right;">                                                                             $624,611.56</td><td style="text-align: right;">                                                                             $624,611.56</td><td style="text-align: right;">                                                                             $624,611.56</td><td style="text-align: right;">                                                                             $624,611.56</td><td style="text-align: right;">                                                                             $624,611.56</td><td style="text-align: right;">                                                                              $624,611.56</td><td style="text-align: right;">                                                                              $624,611.56</td><td style="text-align: right;">                                                                              $624,611.56</td><td style="text-align: right;">                                                                              $624,611.56</td></tr>
</tbody>
</table></div></div>
</div>
<p>We can also easily sum and collapse that aggregation, as it is a Stream`:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingAhotel</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Effective Gross Income for c0348c0f-a31f-421b-b6bc-0fe0d5ea947f [buildingAhotel] Aggregation (sum)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2001-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $6,854,263.68</td></tr>
<tr><td style="text-align: right;">2002-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $7,094,162.91</td></tr>
<tr><td style="text-align: right;">2003-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $7,342,458.61</td></tr>
<tr><td style="text-align: right;">2004-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $7,599,444.66</td></tr>
<tr><td style="text-align: right;">2005-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $7,865,425.23</td></tr>
<tr><td style="text-align: right;">2006-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $8,140,715.11</td></tr>
<tr><td style="text-align: right;">2007-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $8,425,640.14</td></tr>
<tr><td style="text-align: right;">2008-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $8,720,537.54</td></tr>
<tr><td style="text-align: right;">2009-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $9,025,756.36</td></tr>
<tr><td style="text-align: right;">2010-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $9,341,657.83</td></tr>
<tr><td style="text-align: right;">2011-12-31 00:00:00</td><td style="text-align: right;">                                                                                       $9,668,615.85</td></tr>
</tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">buildingAhotel</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Effective Gross Income for c0348c0f-a31f-421b-b6bc-0fe0d5ea947f [buildingAhotel] Aggregation (sum)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2011-12-31 00:00:00</td><td style="text-align: right;">                                                                                      $90,078,677.93</td></tr>
</tbody>
</table></div></div>
</div>
<p>The above subtotals the Effective Gross Income (EGI) for the hotel space of
Building A over the hold period of the asset.</p>
<p>We can then do this for all <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s in the graph, and plot the results:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sunburst</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">)</span>
<span class="n">treemap</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">treemap</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;treemap&quot;</span><span class="p">}]],</span>
    <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Effective Gross Income - Sunburst Plot&#39;</span><span class="p">,</span> <span class="s1">&#39;Effective Gross Income - Treemap Plot&#39;</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">sunburst</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">treemap</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;aggregate_egis_chart.html&#39;</span>

<span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;assets/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="1600"
            src="./aggregate_egis_chart.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
</section>
</section>
<section id="cost-generating-entities">
<h3>Cost-generating Entities<a class="headerlink" href="#cost-generating-entities" title="Link to this heading">#</a></h3>
<p>Let’s now do the same for the cost-generating <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s. While it is routine to
register revenue-generating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s with <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have lettable or
sellable floor space, the convention to also register all cost-generating
<code class="docutils literal notranslate"><span class="pre">Flow</span></code>s with only those same <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s is possibly only done out of convenience
rather than accuracy.</p>
<p>For example, both operating and capital expenses may be attributed to building
systems (e.g. maintenance, upgrading, &amp; replacement of MEP or facade
componentry) that are not coincident with the floor space they are servicing.
I.e., the convention to average (sub)total costs across (sub)total floor space
may be misleading, especially when attempting to compare different scenarios at
different resolutions (See <span id="id1">[<a class="reference internal" href="intro.html#id2" title="R. de Neufville and D. Geltner. Flexibility and Real Estate Valuation under Uncertainty: A Practical Guide for Developers. John Wiley &amp; Sons, Ltd, 2018. ISBN 9781119106470. URL: https://onlinelibrary.wiley.com/doi/abs/10.1002/9781119106470, arXiv:https://onlinelibrary.wiley.com/doi/pdf/10.1002/9781119106470, doi:https://doi.org/10.1002/9781119106470.">dNG18</a>]</span>, 5.4 Flaw of Averages).</p>
<p>By virtue of <em>Rangekeeper</em>’s multi-faceted approach to its object model, costs
can be attributed and aggregated to <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that are not spatially coincident
with the revenue-generating <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s; in the example design, we will
use the ‘services’ relationship-type to register and aggregate some of these,
while space-specific costs will be registered and aggregated via spatial
containment:</p>
<section id="operational-and-capital-expenses-of-building-utilities-systems">
<h4>Operational and Capital Expenses of Building Utilities &amp; Systems<a class="headerlink" href="#operational-and-capital-expenses-of-building-utilities-systems" title="Link to this heading">#</a></h4>
<p>Of course, in a simplified model and without knowing design and engineering
details for the property, costs for operational and capital expenses will be
calculated from some proportional rate of spatial characteristics of the
building. In this example, we will use the following as simplifications of how
these types of costs may be calculated. Note that this is more a demonstration
of methodology, and in practice would adjust to real-world data about the
specific building systems and their costs.</p>
<ul class="simple">
<li><p>‘Floorplate-derived’ Operational and Capital Expenses will be calculated as a
function of the subtotal floorplate area of ‘building’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s. One could
think of this as representing the cost of operating the floor’s MEP, or
maintaining, repairing and upgrading elements on the floors themselves
(e.g. FF&amp;E)</p></li>
<li><p>‘Facade-derived’ Operational Expenses will be calculated as a function of the
surface area of ‘building’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>. This would represent the cost of facade
maintenance, repair or replacement.</p></li>
<li><p>‘Utility-derived’ Capital Expenses will be calculated as a function of the
volume of ‘utility’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s. This represents the cost of repairing and
upgrading the building’s MEP and transportation systems.</p></li>
</ul>
</section>
<section id="cost-flows-per-entity">
<h4>Cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code><a class="headerlink" href="#cost-flows-per-entity" title="Link to this heading">#</a></h4>
<p>There are some properties of <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that we need to produce before we can
calculate <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s off them. In this case we need to produce the facade area
for any <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s that have ‘perimeter’ and ‘ftf’ (Floor-to-Floor height)
properties:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregate Facade Areas:</span>
<span class="k">for</span> <span class="p">(</span><span class="n">entityId</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">property</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;perimeter&#39;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;ftf&#39;</span><span class="p">):</span>
        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;facade_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;perimeter&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;ftf&#39;</span><span class="p">]</span>
<span class="n">spatial_containment</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;facade_area&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_facade_area&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>We now set up operational and capital costing parameters that are based off
either areas or volume, as well as growth rates:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">floor_opex_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=-</span><span class="mi">175</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=-</span><span class="mi">225</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=-</span><span class="mi">125</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=-</span><span class="mi">65</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">facade_opex_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=-</span><span class="mi">25</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">opex_growth_rate</span> <span class="o">=</span> <span class="mf">0.035</span>
<span class="n">floor_capex_per_area_pa</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">hotel</span><span class="o">=-</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">retail</span><span class="o">=-</span><span class="mi">150</span><span class="p">,</span>
    <span class="n">residential</span><span class="o">=-</span><span class="mi">75</span><span class="p">,</span>
    <span class="n">parking</span><span class="o">=-</span><span class="mi">50</span><span class="p">,</span>
    <span class="p">)</span>
<span class="n">cores_capex_per_vol_pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">100</span>
<span class="n">plant_capex_per_vol_pa</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span>
<span class="n">capex_growth_rate</span> <span class="o">=</span> <span class="mf">0.035</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can set up our <code class="docutils literal notranslate"><span class="pre">Costs</span></code> class to produce cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s and <code class="docutils literal notranslate"><span class="pre">Stream</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
            <span class="n">spans</span><span class="p">:</span> <span class="n">Spans</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spans</span> <span class="o">=</span> <span class="n">spans</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@rk</span><span class="o">.</span><span class="n">update_class</span><span class="p">(</span><span class="n">Costs</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate_space_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">floor_opex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Floor-derived Operating Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_floor_opex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;opex_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_sequence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="n">facade_opex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Facade-derived Operating Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_facade_opex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;opex_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_sequence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">opex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Space Operating Expenses&#39;</span><span class="p">,</span>
            <span class="n">flows</span><span class="o">=</span><span class="p">[</span><span class="n">floor_opex</span><span class="p">,</span> <span class="n">facade_opex</span><span class="p">],</span>
            <span class="n">frequency</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>

        <span class="n">floor_capex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Floor-derived Capital Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_floor_capex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
            <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]),</span>
            <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_sequence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">SEMIDECADE</span><span class="p">)),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">floor_capex</span> <span class="o">=</span> <span class="n">floor_capex</span><span class="o">.</span><span class="n">trim_to_span</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="p">)</span>  <span class="c1"># This is to avoid issues with using &gt;yearly periodicity in projection</span>
</pre></div>
</div>
</div>
</div>
<p>We will split the generation of space-based costs from the utility-based costs,
as they will be applied to different <code class="docutils literal notranslate"><span class="pre">Entity</span></code> types:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@rk</span><span class="o">.</span><span class="n">update_class</span><span class="p">(</span><span class="n">Costs</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Costs</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">generate_utils_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">utils_capex</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Utilities-derived Capital Expenses&#39;</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;initial_utility_capex&#39;</span><span class="p">],</span>
            <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Extrapolation</span><span class="p">(</span>
                <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">extrapolation</span><span class="o">.</span><span class="n">Compounding</span><span class="p">(</span>
                    <span class="n">rate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]),</span>
                <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="o">.</span><span class="n">to_sequence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">SEMIDECADE</span><span class="p">)),</span>
            <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utils_capex</span> <span class="o">=</span> <span class="n">utils_capex</span><span class="o">.</span><span class="n">trim_to_span</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spans</span><span class="o">.</span><span class="n">calc_span</span><span class="p">)</span>  <span class="c1"># This is to avoid issues with using &gt;yearly periodicity in projection</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can run the <code class="docutils literal notranslate"><span class="pre">Costs</span></code> class against ‘floor’ and ‘utilities’ <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">floor</span> <span class="ow">in</span> <span class="n">floors</span><span class="p">:</span>
    <span class="n">floor_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;initial_floor_opex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_opex_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">]</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;initial_facade_opex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">facade_opex_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;subtotal_facade_area&#39;</span><span class="p">]</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;initial_floor_capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_capex_per_area_pa</span><span class="p">[</span><span class="n">floor</span><span class="p">[</span><span class="s1">&#39;use&#39;</span><span class="p">]]</span> <span class="o">*</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;subtotal_gfa&#39;</span><span class="p">]</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;opex_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">opex_growth_rate</span>
    <span class="n">floor_params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capex_growth_rate</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">floor_params</span>

    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">floor</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="n">Costs</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">floor_params</span><span class="p">,</span>
        <span class="n">spans</span><span class="o">=</span><span class="n">spans</span><span class="p">)</span>
    <span class="n">costs</span><span class="o">.</span><span class="n">generate_space_costs</span><span class="p">()</span>

    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;opex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">opex</span>
    <span class="n">floor</span><span class="p">[</span><span class="s1">&#39;capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">floor_capex</span>
</pre></div>
</div>
</div>
</div>
<p>The utilities are a bit different, as (for this example), their capex is a
factor of their volume. We can see that the utilities are the cores and plant
of the property:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">utilities</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">filter_by_type</span><span class="p">(</span><span class="n">entity_type</span><span class="o">=</span><span class="s1">&#39;utilities&#39;</span><span class="p">,</span> <span class="n">is_assembly</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;type&#39;</span>
<span class="n">isolated_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">entity</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://speckle.xyz/streams/</span><span class="si">{0}</span><span class="s1">/commits/</span><span class="si">{1}</span><span class="s1">?filter=</span><span class="si">{2}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">stream_id</span><span class="p">,</span>
    <span class="n">commit_id</span><span class="p">,</span>
    <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">(</span>
            <span class="n">propertyInfoKey</span> <span class="o">=</span> <span class="n">key</span><span class="p">,</span>
            <span class="n">isolatedIds</span> <span class="o">=</span> <span class="n">isolated_ids</span><span class="p">))))</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="800"
            src="https://speckle.xyz/streams/c0f66c35e3/commits/9a9670946f?filter=%7B%22propertyInfoKey%22%3A%20%22type%22%2C%20%22isolatedIds%22%3A%20%5B%229b2992a4e98e81b6f2c4b8a57c5dbcf5%22%2C%20%2214147098f0b31f4846dd7144529defd7%22%2C%20%2290da8a6faba34db1ce909900e215019a%22%5D%7D"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">utility</span> <span class="ow">in</span> <span class="n">utilities</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">utility_params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="s1">&#39;plant&#39;</span> <span class="ow">in</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">utility_params</span><span class="p">[</span><span class="s1">&#39;initial_utility_capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plant_capex_per_vol_pa</span> <span class="o">*</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="s1">&#39;cores&#39;</span> <span class="ow">in</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
        <span class="n">utility_params</span><span class="p">[</span><span class="s1">&#39;initial_utility_capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cores_capex_per_vol_pa</span> <span class="o">*</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>
    <span class="n">utility_params</span><span class="p">[</span><span class="s1">&#39;capex_growth_rate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">capex_growth_rate</span>
    <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">utility_params</span>

    <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">utility</span><span class="p">,</span> <span class="s1">&#39;events&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;events&#39;</span><span class="p">]</span>

    <span class="n">costs</span> <span class="o">=</span> <span class="n">Costs</span><span class="p">(</span>
        <span class="n">params</span><span class="o">=</span><span class="n">utility_params</span><span class="p">,</span>
        <span class="n">spans</span><span class="o">=</span><span class="n">spans</span><span class="p">)</span>
    <span class="n">costs</span><span class="o">.</span><span class="n">generate_utils_costs</span><span class="p">()</span>

    <span class="n">utility</span><span class="p">[</span><span class="s1">&#39;capex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">costs</span><span class="o">.</span><span class="n">utils_capex</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">utilities</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;capex&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Utilities-derived Capital Expenses</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2005-12-31 00:00:00</td><td style="text-align: right;">                        -$643,105.79</td></tr>
<tr><td style="text-align: right;">2010-12-31 00:00:00</td><td style="text-align: right;">                        -$665,614.49</td></tr>
</tbody>
</table></div></div>
</div>
<p>And finally aggregate them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_opex</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Operational Expenses&#39;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
<span class="nb">property</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_opex</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;opex&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_capex</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Capital Expenses&#39;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
<span class="nb">property</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_capex</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;capex&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>If we wish to see the ultimate aggregation of those costs, we can do so by
totalling them at their root <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">property_opex</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">property_capex</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Property Average Periodic OPEX: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">property_opex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Property Average Periodic CAPEX: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">property_capex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Property Average Periodic OPEX: $-7,488,734.31
Property Average Periodic CAPEX: $-2,007,558.91
</pre></div>
</div>
</div>
</div>
<p>To get a sense check if this is reasonable, we can compare the opex and capex
to the PGI. First let’s aggregate the PGI for all <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_pgis</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Potential Gross Income&#39;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spatial_containment</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;pgi&#39;</span><span class="p">,</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_pgis</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_pgi&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And total it to the root <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">property_pgi</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;subtotal_pgi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Property Average Periodic PGI: $</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">property_pgi</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Property Average Periodic PGI: $18,918,012.54
</pre></div>
</div>
</div>
</div>
<p>Now we can calculate the Expenses ratios:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Property OpEx as proportion of PGI: </span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">property_opex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">property_pgi</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Property OpEx as proportion of PGI: 39.59%
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Property CapEx as proportion of PGI: </span><span class="si">{:.2%}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">property_capex</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">property_pgi</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">mean</span><span class="p">()))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Property CapEx as proportion of PGI: 10.61%
</pre></div>
</div>
</div>
</div>
<p>Looking at just the cost-producing <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s, we can see that in the OpEx and
CapEx breakdowns, there is a significant amount of cost generated by non-floor
(i.e., non-revenue-generating) <code class="docutils literal notranslate"><span class="pre">Entity</span></code>s, like cores and plant. This type of
analysis is important in understanding the cost drivers of a property, and
where the most effective cost-saving measures could be applied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">opex</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">)</span>
<span class="n">capex</span> <span class="o">=</span> <span class="n">spatial_containment</span><span class="o">.</span><span class="n">sunburst</span><span class="p">(</span><span class="nb">property</span><span class="o">=</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plotly</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">make_subplots</span><span class="p">(</span>
    <span class="n">rows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">specs</span><span class="o">=</span><span class="p">[[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}],</span> <span class="p">[{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;sunburst&quot;</span><span class="p">}]],</span>
    <span class="n">subplot_titles</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Total Operational Expenses&#39;</span><span class="p">,</span> <span class="s1">&#39;Total Capital Expenses&#39;</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">opex</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">append_trace</span><span class="p">(</span><span class="n">capex</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">filename</span><span class="o">=</span><span class="s1">&#39;aggregate_exp_chart.html&#39;</span>

<span class="n">py</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;assets/</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">auto_open</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">IFrame</span><span class="p">(</span><span class="n">src</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;./</span><span class="si">{</span><span class="n">filename</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="s1">&#39;100%&#39;</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">800</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">fig</span><span class="o">.</span><span class="n">data</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">
        <iframe
            width="100%"
            height="1600"
            src="./aggregate_exp_chart.html"
            frameborder="0"
            allowfullscreen
            
        ></iframe>
        </div></div>
</div>
</section>
</section>
</section>
<section id="calculating-overall-valuation">
<h2>Calculating Overall Valuation<a class="headerlink" href="#calculating-overall-valuation" title="Link to this heading">#</a></h2>
<p>Now that we have our revenues and cost line items (<code class="docutils literal notranslate"><span class="pre">Flow</span></code>s) generated per
<code class="docutils literal notranslate"><span class="pre">Entity</span></code>, we can accumulate them into Net Operating Income (NOI) and
Net Annual Cashflow (NACF) subtotals, as well as the reversion (disposition, or
sale) of the whole asset, in order to determine the overall valuation of the
property.</p>
<p>We can also calculate the net position of each <code class="docutils literal notranslate"><span class="pre">Entity</span></code> as its ‘Net Annual
Cashflow (NACF)’:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">entity</span> <span class="ow">in</span> <span class="nb">property</span><span class="o">.</span><span class="n">get_entities</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="n">noi</span> <span class="o">=</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;egi&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;opex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)]</span>
    <span class="n">noi</span> <span class="o">=</span> <span class="p">[</span><span class="n">flow</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">flow</span><span class="p">,</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">)</span> <span class="k">else</span> <span class="n">flow</span> <span class="k">for</span> <span class="n">flow</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">noi</span><span class="p">))]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noi</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;noi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Operating Income&#39;</span><span class="p">,</span>
            <span class="n">flows</span><span class="o">=</span><span class="n">noi</span><span class="p">,</span>
            <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">capex</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="s1">&#39;capex&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">capex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">entity</span><span class="p">[</span><span class="s1">&#39;nacf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Annual Cashflow&#39;</span><span class="p">,</span>
                <span class="n">flows</span><span class="o">=</span><span class="n">entity</span><span class="p">[</span><span class="s1">&#39;noi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">flows</span> <span class="o">+</span> <span class="p">[</span><span class="n">capex</span><span class="p">],</span>
                <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_noi</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Operating Income&#39;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
<span class="nb">property</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_noi</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;noi&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_noi&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">aggregate_nacf</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">rk</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">Entity</span><span class="o">.</span><span class="n">aggregate_flows</span><span class="p">(</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Annual Cashflow&#39;</span><span class="p">,</span>
        <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">)</span>
<span class="nb">property</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
    <span class="n">function</span><span class="o">=</span><span class="n">aggregate_nacf</span><span class="p">,</span>
    <span class="nb">property</span><span class="o">=</span><span class="s1">&#39;nacf&#39;</span><span class="p">,</span>
    <span class="n">label</span><span class="o">=</span><span class="s1">&#39;subtotal_nacf&#39;</span><span class="p">,</span>
    <span class="n">relationship_type</span><span class="o">=</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="reversion">
<h3>Reversion<a class="headerlink" href="#reversion" title="Link to this heading">#</a></h3>
<p>To calculate the reversion cashflow, we set up a period that spans the 10th year
of the project. This only applies to the asset as a whole, so it is recorded
at the root <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">root</span> <span class="o">=</span> <span class="nb">property</span><span class="o">.</span><span class="n">get_roots</span><span class="p">()[</span><span class="s1">&#39;spatiallyContains&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reversion_span</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">Span</span><span class="o">.</span><span class="n">from_duration</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Reversion&#39;</span><span class="p">,</span>
    <span class="n">date</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">pd</span><span class="o">.</span><span class="n">DateOffset</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
    <span class="n">duration</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])</span>

<span class="n">exit_caprate</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">reversion_flow</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Flow</span><span class="o">.</span><span class="n">from_projection</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Reversion&#39;</span><span class="p">,</span>
    <span class="n">value</span><span class="o">=</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_nacf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">exit_caprate</span><span class="p">,</span>
    <span class="n">proj</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">projection</span><span class="o">.</span><span class="n">Distribution</span><span class="p">(</span>
        <span class="n">form</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">distribution</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(),</span>
        <span class="n">sequence</span><span class="o">=</span><span class="n">reversion_span</span><span class="o">.</span><span class="n">to_sequence</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;frequency&#39;</span><span class="p">])),</span>
    <span class="n">units</span><span class="o">=</span><span class="n">currency</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
<span class="n">root</span><span class="p">[</span><span class="s1">&#39;reversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reversion_flow</span>
<span class="n">reversion_flow</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">      Reversion</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2010-12-31 00:00:00</td><td style="text-align: right;">$284,674,637.71</td></tr>
</tbody>
</table></div></div>
</div>
<p>Now we can aggregate the net and reversion cashflows in the root <code class="docutils literal notranslate"><span class="pre">Entity</span></code> in
order to derive the project’s complete cashflows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">net_cashflows_with_reversion</span> <span class="o">=</span> <span class="p">(</span><span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Net Cashflow with Reversion&#39;</span><span class="p">,</span>
    <span class="n">flows</span><span class="o">=</span><span class="p">[</span><span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_nacf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;reversion&#39;</span><span class="p">]],</span>
    <span class="n">frequency</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span><span class="p">)</span>
        <span class="o">.</span><span class="n">trim_to_span</span><span class="p">(</span>
            <span class="n">rk</span><span class="o">.</span><span class="n">span</span><span class="o">.</span><span class="n">Span</span><span class="p">(</span>
                <span class="n">start_date</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">],</span>
                <span class="n">end_date</span><span class="o">=</span><span class="n">reversion_span</span><span class="o">.</span><span class="n">end_date</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>
<span class="n">root</span><span class="p">[</span><span class="s1">&#39;nacf_reversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">net_cashflows_with_reversion</span>
<span class="n">net_cashflows_with_reversion</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">  date</th><th style="text-align: right;">  Net Annual Cashflow for afe8e730-ad0f-4c2a-a15c-e249e4518fa8 [property] Aggregation (sum)</th><th style="text-align: right;">      Reversion</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">  2001</td><td style="text-align: right;">                                                                              $8,134,691.89</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2002</td><td style="text-align: right;">                                                                              $8,599,446.40</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2003</td><td style="text-align: right;">                                                                              $9,091,532.28</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2004</td><td style="text-align: right;">                                                                              $9,612,601.91</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2005</td><td style="text-align: right;">                                                                              $6,862,704.94</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2006</td><td style="text-align: right;">                                                                             $10,748,821.65</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2007</td><td style="text-align: right;">                                                                             $11,367,816.34</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2008</td><td style="text-align: right;">                                                                             $12,023,498.34</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2009</td><td style="text-align: right;">                                                                             $12,718,103.14</td><td style="text-align: right;">              0</td></tr>
<tr><td style="text-align: right;">  2010</td><td style="text-align: right;">                                                                             $10,036,741.15</td><td style="text-align: right;">$284,674,637.71</td></tr>
</tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">rk</span><span class="o">.</span><span class="n">flux</span><span class="o">.</span><span class="n">Stream</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Table 1.1&#39;</span><span class="p">,</span>
    <span class="n">flows</span><span class="o">=</span><span class="p">[</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_egi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_opex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_noi&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_capex&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;subtotal_nacf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;reversion&#39;</span><span class="p">],</span>
        <span class="n">root</span><span class="p">[</span><span class="s1">&#39;nacf_reversion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="p">],</span>
    <span class="n">frequency</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span>
    <span class="p">)</span>
<span class="n">table</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">  date</th><th style="text-align: right;">  Effective Gross Income for afe8e730-ad0f-4c2a-a15c-e249e4518fa8 [property] Aggregation (sum)</th><th style="text-align: right;">  Operational Expenses for afe8e730-ad0f-4c2a-a15c-e249e4518fa8 [property] Aggregation (sum)</th><th style="text-align: right;">  Net Operating Income for afe8e730-ad0f-4c2a-a15c-e249e4518fa8 [property] Aggregation (sum)</th><th style="text-align: right;">  Capital Expenses for afe8e730-ad0f-4c2a-a15c-e249e4518fa8 [property] Aggregation (sum)</th><th style="text-align: right;">  Net Annual Cashflow for afe8e730-ad0f-4c2a-a15c-e249e4518fa8 [property] Aggregation (sum)</th><th style="text-align: right;">      Reversion</th><th style="text-align: right;">  Net Cashflow with Reversion (sum)</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">  2001</td><td style="text-align: right;">                                                                                $14,402,849.55</td><td style="text-align: right;">                                                                              -$6,268,157.66</td><td style="text-align: right;">                                                                               $8,134,691.89</td><td style="text-align: right;">                                                                                       0</td><td style="text-align: right;">                                                                              $8,134,691.89</td><td style="text-align: right;">              0</td><td style="text-align: right;">                      $8,134,691.89</td></tr>
<tr><td style="text-align: right;">  2002</td><td style="text-align: right;">                                                                                $15,086,989.58</td><td style="text-align: right;">                                                                              -$6,487,543.18</td><td style="text-align: right;">                                                                               $8,599,446.40</td><td style="text-align: right;">                                                                                       0</td><td style="text-align: right;">                                                                              $8,599,446.40</td><td style="text-align: right;">              0</td><td style="text-align: right;">                      $8,599,446.40</td></tr>
<tr><td style="text-align: right;">  2003</td><td style="text-align: right;">                                                                                $15,806,139.47</td><td style="text-align: right;">                                                                              -$6,714,607.19</td><td style="text-align: right;">                                                                               $9,091,532.28</td><td style="text-align: right;">                                                                                       0</td><td style="text-align: right;">                                                                              $9,091,532.28</td><td style="text-align: right;">              0</td><td style="text-align: right;">                      $9,091,532.28</td></tr>
<tr><td style="text-align: right;">  2004</td><td style="text-align: right;">                                                                                $16,562,220.35</td><td style="text-align: right;">                                                                              -$6,949,618.44</td><td style="text-align: right;">                                                                               $9,612,601.91</td><td style="text-align: right;">                                                                                       0</td><td style="text-align: right;">                                                                              $9,612,601.91</td><td style="text-align: right;">              0</td><td style="text-align: right;">                      $9,612,601.91</td></tr>
<tr><td style="text-align: right;">  2005</td><td style="text-align: right;">                                                                                $17,357,265.38</td><td style="text-align: right;">                                                                              -$7,192,855.09</td><td style="text-align: right;">                                                                              $10,164,410.29</td><td style="text-align: right;">                                                                          -$5,919,092.61</td><td style="text-align: right;">                                                                              $6,862,704.94</td><td style="text-align: right;">              0</td><td style="text-align: right;">                      $6,862,704.94</td></tr>
<tr><td style="text-align: right;">  2006</td><td style="text-align: right;">                                                                                $18,193,426.66</td><td style="text-align: right;">                                                                              -$7,444,605.02</td><td style="text-align: right;">                                                                              $10,748,821.65</td><td style="text-align: right;">                                                                                   $0.00</td><td style="text-align: right;">                                                                             $10,748,821.65</td><td style="text-align: right;">              0</td><td style="text-align: right;">                     $10,748,821.65</td></tr>
<tr><td style="text-align: right;">  2007</td><td style="text-align: right;">                                                                                $19,072,982.53</td><td style="text-align: right;">                                                                              -$7,705,166.19</td><td style="text-align: right;">                                                                              $11,367,816.34</td><td style="text-align: right;">                                                                                   $0.00</td><td style="text-align: right;">                                                                             $11,367,816.34</td><td style="text-align: right;">              0</td><td style="text-align: right;">                     $11,367,816.34</td></tr>
<tr><td style="text-align: right;">  2008</td><td style="text-align: right;">                                                                                $19,998,345.35</td><td style="text-align: right;">                                                                              -$7,974,847.01</td><td style="text-align: right;">                                                                              $12,023,498.34</td><td style="text-align: right;">                                                                                   $0.00</td><td style="text-align: right;">                                                                             $12,023,498.34</td><td style="text-align: right;">              0</td><td style="text-align: right;">                     $12,023,498.34</td></tr>
<tr><td style="text-align: right;">  2009</td><td style="text-align: right;">                                                                                $20,972,069.80</td><td style="text-align: right;">                                                                              -$8,253,966.66</td><td style="text-align: right;">                                                                              $12,718,103.14</td><td style="text-align: right;">                                                                                   $0.00</td><td style="text-align: right;">                                                                             $12,718,103.14</td><td style="text-align: right;">              0</td><td style="text-align: right;">                     $12,718,103.14</td></tr>
<tr><td style="text-align: right;">  2010</td><td style="text-align: right;">                                                                                $21,996,861.68</td><td style="text-align: right;">                                                                              -$8,542,855.49</td><td style="text-align: right;">                                                                              $13,454,006.19</td><td style="text-align: right;">                                                                          -$6,126,260.85</td><td style="text-align: right;">                                                                             $10,036,741.15</td><td style="text-align: right;">$284,674,637.71</td><td style="text-align: right;">                    $294,711,378.86</td></tr>
<tr><td style="text-align: right;">  2011</td><td style="text-align: right;">                                                                                $23,075,587.32</td><td style="text-align: right;">                                                                              -$8,841,855.43</td><td style="text-align: right;">                                                                              $14,233,731.89</td><td style="text-align: right;">                                                                                       0</td><td style="text-align: right;">                                                                             $14,233,731.89</td><td style="text-align: right;">              0</td><td style="text-align: right;">                                  0</td></tr>
</tbody>
</table></div></div>
</div>
</section>
<section id="valuation">
<h3>Valuation<a class="headerlink" href="#valuation" title="Link to this heading">#</a></h3>
<p>With our net cashflows including reversion, if we specify a discount rate, we
can calculate the present value of the property:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">discount_rate</span> <span class="o">=</span> <span class="mf">0.07</span>
<span class="n">pvs</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s1">&#39;nacf_reversion&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pv</span><span class="p">(</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Present Value&#39;</span><span class="p">,</span>
    <span class="n">frequency</span><span class="o">=</span><span class="n">rk</span><span class="o">.</span><span class="n">duration</span><span class="o">.</span><span class="n">Type</span><span class="o">.</span><span class="n">YEAR</span><span class="p">,</span>
    <span class="n">rate</span><span class="o">=</span><span class="n">discount_rate</span><span class="p">)</span>
<span class="n">pvs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<thead>
<tr><th style="text-align: right;">               date</th><th style="text-align: right;">  Present Value</th></tr>
</thead>
<tbody>
<tr><td style="text-align: right;">2001-12-31 00:00:00</td><td style="text-align: right;">  $7,602,515.78</td></tr>
<tr><td style="text-align: right;">2002-12-31 00:00:00</td><td style="text-align: right;">  $7,511,089.53</td></tr>
<tr><td style="text-align: right;">2003-12-31 00:00:00</td><td style="text-align: right;">  $7,421,398.50</td></tr>
<tr><td style="text-align: right;">2004-12-31 00:00:00</td><td style="text-align: right;">  $7,333,407.97</td></tr>
<tr><td style="text-align: right;">2005-12-31 00:00:00</td><td style="text-align: right;">  $4,893,013.78</td></tr>
<tr><td style="text-align: right;">2006-12-31 00:00:00</td><td style="text-align: right;">  $7,162,393.72</td></tr>
<tr><td style="text-align: right;">2007-12-31 00:00:00</td><td style="text-align: right;">  $7,079,304.69</td></tr>
<tr><td style="text-align: right;">2008-12-31 00:00:00</td><td style="text-align: right;">  $6,997,785.50</td></tr>
<tr><td style="text-align: right;">2009-12-31 00:00:00</td><td style="text-align: right;">  $6,917,805.44</td></tr>
<tr><td style="text-align: right;">2010-12-31 00:00:00</td><td style="text-align: right;">$149,816,320.83</td></tr>
</tbody>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">property_pv</span> <span class="o">=</span> <span class="n">pvs</span><span class="o">.</span><span class="n">collapse</span><span class="p">()</span><span class="o">.</span><span class="n">movements</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Property PV: $</span><span class="si">{:,.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">property_pv</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Property PV: $212,735,036
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="load_design.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Loading a Design</p>
      </div>
    </a>
    <a class="right-next"
       href="test_dotnet.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">&lt;no title&gt;</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#load-the-design">Load the Design</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#inspect-the-model-graph">Inspect the Model Graph</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#assigning-and-aggregating-flows-per-entity">Assigning and Aggregating <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#revenue-producing-entities">Revenue-producing Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-aggregation">Simple Aggregation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-a-financial-calculation">Aggregating a (Financial) Calculation</a><ul class="nav section-nav flex-column">
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#streams-of-revenue-flows-per-entity"><code class="docutils literal notranslate"><span class="pre">Stream</span></code>s of Revenue <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code>:</a></li>
<li class="toc-h5 nav-item toc-entry"><a class="reference internal nav-link" href="#aggregating-by-parent-container">Aggregating by Parent Container</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-generating-entities">Cost-generating Entities</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#operational-and-capital-expenses-of-building-utilities-systems">Operational and Capital Expenses of Building Utilities &amp; Systems</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cost-flows-per-entity">Cost <code class="docutils literal notranslate"><span class="pre">Flow</span></code>s per <code class="docutils literal notranslate"><span class="pre">Entity</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#calculating-overall-valuation">Calculating Overall Valuation</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#reversion">Reversion</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#valuation">Valuation</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Daniel Fink
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>